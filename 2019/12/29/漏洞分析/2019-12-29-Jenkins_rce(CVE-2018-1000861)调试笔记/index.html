<!DOCTYPE html>
<html lang=en>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:description" content="">
    <meta property="og:type" content="website">
    <meta name="description" content="">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        Jenkins rce(CVE-2018-1000861)调试笔记 - undefined
        
    </title>

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/aircloud.css">

    
<link rel="stylesheet" href="/css/gitment.css">

    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_28hi1hpxx24.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
<meta name="generator" content="Hexo 6.2.0"></head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i>  </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar ">
            <img src="/img/avatar.jpeg" />
        </div>
        <div class="name">
            <i>seaii</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>HOME</span>
                </a>
            </li>
            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>TAGS</span>
                </a>
            </li>
            <li >
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>ARCHIVES</span>
                </a>
            </li>
            <li >
                <a href="/collect/">
                    <i class="iconfont icon-shoucang1"></i>
                    <span>COLLECT</span>
                </a>
            </li>
            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>ABOUT</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x00-%E5%89%8D%E8%A8%80"><span class="toc-text">0x00 前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-text">0x01 环境搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-text">0x02 漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E8%A7%A3%E6%9E%90"><span class="toc-text">路由解析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BB%E6%89%BE%E5%88%A9%E7%94%A8%E9%93%BE"><span class="toc-text">寻找利用链</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-text">0x03 参考链接</span></a></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-bg" id="search-bg"></div>
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">search</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i>  </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        Jenkins rce(CVE-2018-1000861)调试笔记
    </div>

    <div class="post-meta">
        <span class="attr">Post：<span>2019-12-29 11:46:00</span></span>
        
        </span>
        <span class="attr">Visit：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content ">
        <h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>知识补漏行动继续，这次是jenkins。</p>
<span id="more"></span>


<h2 id="0x01-环境搭建"><a href="#0x01-环境搭建" class="headerlink" title="0x01 环境搭建"></a>0x01 环境搭建</h2><p>搭环境最惨的就是踩了一堆坑之后发现前边做的都是没用的。。。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/jenkinsci/jenkins.git</span><br><span class="line"><span class="built_in">cd</span> jenkins</span><br><span class="line">git checkout jenkins-2.136 <span class="comment">#默认关闭anonymous read access的情况下，影响版本为&lt;=1.137</span></span><br><span class="line">mvn clean install -pl war -am -DskipTests <span class="comment">#编译war包</span></span><br><span class="line"><span class="built_in">cd</span> war</span><br><span class="line">mvnDebug org.jenkins-ci.tools:maven-jenkins-dev-plugin:run <span class="comment">#以debug模式运行，调试端口8000，web端口8080，暂时不知道咋换。。。</span></span><br></pre></td></tr></table></figure>

<p>接下来在idea配置远程调试：</p>
<p><img src="https://mdpicture.oss-cn-beijing.aliyuncs.com/20191101181625.png"></p>
<p>注意以调试模式运行时，只有接收到idea的调试链接之后才会继续运行。</p>
<p>调试模式启动的jenkins没有任何插件，需要手工安装，可以将vulhub环境中的<code>/var/jenkins_home/plugins</code>复制到本地的<code>jenkins/war/work/plugins</code>。也没有默认的登陆认证，也可以用vulhub中的配置文件。</p>
<p>另外要注意的一点是，jenkins的默认配置中，匿名用户的读权限也是默认关闭的：</p>
<p><img src="https://mdpicture.oss-cn-beijing.aliyuncs.com/20191107172519.png"></p>
<h2 id="0x02-漏洞分析"><a href="#0x02-漏洞分析" class="headerlink" title="0x02 漏洞分析"></a>0x02 漏洞分析</h2><h3 id="路由解析"><a href="#路由解析" class="headerlink" title="路由解析"></a>路由解析</h3><p><code>jenkins/war/src/main/webapp/WEB-INF/web.xml</code></p>
<p><img src="https://mdpicture.oss-cn-beijing.aliyuncs.com/20191110163727.png"></p>
<p>从web.xml可以看到jenkins将所有的请求发送到<code>org.kohsuke.stapler.Stapler</code>这个servlet进行统一处理，跟进看一下<code>org/kohsuke/stapler/stapler/1.254.1/stapler-1.254.1-sources.jar!/org/kohsuke/stapler/Stapler.java</code>的<code>service</code>方法：</p>
<p><img src="https://mdpicture.oss-cn-beijing.aliyuncs.com/20191110164214.png"></p>
<p>在处理一些特殊情况之后，会创建一个根结点（这里暂时理解为jenkins对路由的处理是将其转化为一个一个的节点），进入<code>invoke</code>方法：</p>
<p><code>org/kohsuke/stapler/stapler/1.254.1/stapler-1.254.1-sources.jar!/org/kohsuke/stapler/Stapler.java</code></p>
<p><img src="https://mdpicture.oss-cn-beijing.aliyuncs.com/20191110164931.png"></p>
<p>在这里将url按照<code>/</code>进行分割，并进一步封装request和response对象。</p>
<p><code>org/kohsuke/stapler/stapler/1.254.1/stapler-1.254.1-sources.jar!/org/kohsuke/stapler/TokenList.java</code></p>
<p><img src="https://mdpicture.oss-cn-beijing.aliyuncs.com/20191110164832.png"></p>
<p>最后请求会进入<code>tryInvoke</code>方法中进行处理：</p>
<p><code>org/kohsuke/stapler/stapler/1.254.1/stapler-1.254.1-sources.jar!/org/kohsuke/stapler/Stapler.java</code></p>
<p><img src="https://mdpicture.oss-cn-beijing.aliyuncs.com/20191110171226.png"></p>
<p>如果节点的类型为<code>StaplerProxy</code>，会检查用户是否有权限访问该路由：</p>
<p><code>jenkins/core/src/main/java/jenkins/model/Jenkins.java</code></p>
<p><img src="https://mdpicture.oss-cn-beijing.aliyuncs.com/20191110171912.png"></p>
<p>在第一次权限检查失败之后，会有一个二次检查：</p>
<p><img src="https://mdpicture.oss-cn-beijing.aliyuncs.com/20191110172417.png"></p>
<p>如果我们访问的url在白名单中，是可以通过权限检测的。</p>
<p><img src="https://mdpicture.oss-cn-beijing.aliyuncs.com/20191110175413.png"></p>
<p>回到<code>tryInvoke</code>方法：</p>
<p><img src="https://mdpicture.oss-cn-beijing.aliyuncs.com/20191110175413.png"></p>
<p>根据node获取metaClass，在这个过程中有一个<code>buildDispatchers</code>方法，它的主要作用就是寻找对应的node节点与相应的处理方法（<strong>继承家族树中的所有类</strong>）并把这个方法加入到分配器dispatchers中。</p>
<p>由于这个方法特别长，总结起来就是遍历一个方法列表，如果有符合如下条件的dispatcher，就添加到<code>metaClass.dispatchers</code>中：</p>
<blockquote>
<ul>
<li><code>.do(...)</code>也就是<code>do(...)</code>和<code>@WebMethod</code>标注的方法</li>
<li><code>.doIndex(...)</code></li>
<li><code>js</code>也就是<code>js(...)</code></li>
<li>有<code>@JavaScriptMethod</code>标注的方法</li>
<li><code>NODE.getTOKEN()</code>也就是<code>get()</code></li>
<li><code>NODE.getTOKEN(StaplerRequest)</code>也就是<code>get(StaplerRequest)</code></li>
<li><code>.get(String)</code>也就是<code>get(String)</code></li>
<li><code>.get(int)</code>也就是<code>get(int)</code></li>
<li><code>.get(long)</code>也就是<code>get(long)</code></li>
<li><code>.getDynamic(,...)</code>也就是<code>getDynamic()</code></li>
<li><code>.doDynamic(...)</code>也就是<code>doDynamic()</code></li>
</ul>
</blockquote>
<p>然后遍历metaClass的所有dispatcher，找到符合路由的dispatcher进行调用：</p>
<p><img src="https://mdpicture.oss-cn-beijing.aliyuncs.com/20191110180119.png"></p>
<p>继续跟进：</p>
<p><code>org/kohsuke/stapler/stapler/1.254.1/stapler-1.254.1-sources.jar!/org/kohsuke/stapler/MetaClass.java</code></p>
<p><img src="https://mdpicture.oss-cn-beijing.aliyuncs.com/20191110180436.png"></p>
<p><img src="https://mdpicture.oss-cn-beijing.aliyuncs.com/20191110180506.png"></p>
<p>这里首先调用了<code>getSecurityRealm</code>方法，返回的结果作为新的node，再次进入<code>tryInvoke</code>方法进行递归解析，直到url解析完毕。</p>
<p>到这里路由解析的流程就梳理清楚了，如果能够找到token对应的方法，就调用，找不到就作为上一个方法的参数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://jenkin.local/adjuncts/whatever/class/classLoader/resource/index.jsp/content</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">jenkins.model.Jenkins.getAdjuncts(<span class="string">&quot;whatever&quot;</span>) </span><br><span class="line">.getClass()</span><br><span class="line">.getClassLoader()</span><br><span class="line">.getResource(<span class="string">&quot;index.jsp&quot;</span>)</span><br><span class="line">.getContent()</span><br></pre></td></tr></table></figure>

<p>这个漏洞利用的核心点就在于通过寻找getter方法，构成一条利用链，直到rce。</p>
<h3 id="寻找利用链"><a href="#寻找利用链" class="headerlink" title="寻找利用链"></a>寻找利用链</h3><p>payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:8080/jenkins/securityRealm/user/admin/descriptorByName/org.jenkinsci.plugins.scriptsecurity.sandbox.groovy.SecureGroovyScript/checkScript?sandbox=true&amp;value=import+groovy.transform.*%0a%40ASTTest(value%3d%7bassert+java.lang.Runtime.getRuntime().exec(%22open+%2fApplications%2fCalculator.app%22)%7d)%0aclass+Person%7b%7d</span><br></pre></td></tr></table></figure>

<p>从前面的分析中我们知道路由<code>/securityRealm</code>是在白名单中的，任何权限都可以访问：</p>
<p>解析之后会得到一个<code>HudsonPrivateSecurityRealm</code>类型的对象：</p>
<p><code>jenkins/core/src/main/java/jenkins/model/Jenkins.java</code></p>
<p><img src="https://mdpicture.oss-cn-beijing.aliyuncs.com/20191111161939.png"></p>
<p>查看对应的dispatchers，发现能够接收用户输入的只有：</p>
<p><img src="https://mdpicture.oss-cn-beijing.aliyuncs.com/20191111162817.png"></p>
<p>同样的方法我们会得到一个<code>hudson.model.User</code>的对象，到这里看起来还没有利用漏洞的点，继续找接收用户输入的dispatcher：</p>
<p><img src="https://mdpicture.oss-cn-beijing.aliyuncs.com/20191111172733.png"></p>
<p><code>jenkins/core/src/main/java/hudson/model/DescriptorByNameOwner.java</code></p>
<p><img src="https://mdpicture.oss-cn-beijing.aliyuncs.com/20191111172959.png"></p>
<p>一路跟进来到<code>jenkins/core/src/main/java/jenkins/model/Jenkins.java</code>：</p>
<p><img src="https://mdpicture.oss-cn-beijing.aliyuncs.com/20191111173326.png"></p>
<p>这里会获取当前jenkins安装的所有插件，如果与传入参数匹配，则返回。这里选择了<code>org.jenkinsci.plugins.scriptsecurity.sandbox.groovy.SecureGroovyScript</code>这个插件，希望通过执行groovy脚本来达到rce的目的。</p>
<p><code>org/jenkins-ci/plugins/script-security/1.13/script-security-1.13-sources.jar!/org/jenkinsci/plugins/scriptsecurity/sandbox/groovy/SecureGroovyScript.java</code></p>
<p><img src="https://mdpicture.oss-cn-beijing.aliyuncs.com/20191111180648.png"></p>
<p>调用栈如下：</p>
<p><img src="https://mdpicture.oss-cn-beijing.aliyuncs.com/20191111180752.png"></p>
<p>下面就是在我看来这个洞最nb的地方，通常我们认为恶意代码只有在运行的时候才能造成危害，但是编程语言为了让自身更加灵活，会赋予自身许多动态特性，比如java中的字节码，是在编译的时候才将字节码插入指定的类中。我们能否寻找一些在编译时就执行命令的groovy script呢？答案当然是肯定的。</p>
<p>在orange大佬提出这个思路之后，许许多多的大佬贡献了非常多的利用方式，在这篇<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/6361">Jenkins RCE漏洞分析汇总</a>中有详细的记录，就不再copy了XD。</p>
<h2 id="0x03-参考链接"><a href="#0x03-参考链接" class="headerlink" title="0x03 参考链接"></a>0x03 参考链接</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/caiqiiqi/article/details/90518988">Jenkins调试的两种方法</a></p>
<p>[Jenkins RCE分析（CVE-2018-1000861分析）](<a target="_blank" rel="noopener" href="https://lucifaer.com/2019/03/04/Jenkins">https://lucifaer.com/2019/03/04/Jenkins</a> RCE分析（CVE-2018-1000861分析）)</p>
<p><a target="_blank" rel="noopener" href="https://devco.re/blog/2019/01/16/hacking-Jenkins-part1-play-with-dynamic-routing/">Hacking Jenkins Part 1 - Play with Dynamic Routing</a></p>
<p><a target="_blank" rel="noopener" href="https://devco.re/blog/2019/02/19/hacking-Jenkins-part2-abusing-meta-programming-for-unauthenticated-RCE/">Hacking Jenkins Part 2 - Abusing Meta Programming for Unauthenticated RCE!</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/6361">Jenkins RCE漏洞分析汇总</a></p>

        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>
        <div id="lv-container"></div>
        <div class="giscus"></div>
    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>  Theme <a target="_blank" rel="noopener" href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = ""
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>

<script src="/js/index.js"></script>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>






</html>
