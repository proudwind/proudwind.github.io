<!DOCTYPE html>
<html lang=zh-CN>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:description" content="">
    <meta property="og:type" content="website">
    <meta name="description" content="">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        Thinkphp5实现安全数据库操作以及部分运行流程分析 - Seaii&#39;s Blog
        
    </title>

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/aircloud.css">

    
<link rel="stylesheet" href="/css/gitment.css">

    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_28hi1hpxx24.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
<meta name="generator" content="Hexo 6.2.0"></head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i>  </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar ">
            <img src="/img/avatar.jpeg" />
        </div>
        <div class="name">
            <i>seaii</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li >
                <a href="/collect/">
                    <i class="iconfont icon-shoucang1"></i>
                    <span>收藏</span>
                </a>
            </li>
            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#0x01-%E5%89%8D%E8%A8%80"><span class="toc-text">0x01 前言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x02-%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-text">0x02 准备工作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x03-%E5%88%86%E6%9E%90"><span class="toc-text">0x03 分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-input"><span class="toc-text">3.1 input()</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-1-post"><span class="toc-text">3.1.1 post()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-2-input"><span class="toc-text">3.1.2 input()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-3-filterValue"><span class="toc-text">3.1.3 filterValue()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-4-filterExp"><span class="toc-text">3.1.4 filterExp() *</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-select"><span class="toc-text">3.2 select()</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2-1-parseWhere"><span class="toc-text">3.2.1 parseWhere()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2-2-parseWhereItem"><span class="toc-text">3.2.2 parseWhereItem()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2-3-parseValue"><span class="toc-text">3.2.3 parseValue()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2-4-%E5%9B%9E%E5%88%B0filterExp"><span class="toc-text">3.2.4 回到filterExp()</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-%E7%95%AA%E5%A4%96"><span class="toc-text">3.3 番外</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x04-5-0-10%E7%89%88%E6%9C%AC%E7%9A%84%E4%B8%80%E5%A4%84%E6%B3%A8%E5%85%A5"><span class="toc-text">0x04 5.0.10版本的一处注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x05-%E6%9C%80%E5%90%8E"><span class="toc-text">0x05 最后</span></a></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-bg" id="search-bg"></div>
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i>  </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        Thinkphp5实现安全数据库操作以及部分运行流程分析
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2017-10-02 21:48:00</span></span>
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content ">
        <h3 id="0x01-前言"><a href="#0x01-前言" class="headerlink" title="0x01 前言"></a>0x01 前言</h3><p>文章的灵感来自于此文<a target="_blank" rel="noopener" href="https://xianzhi.aliyun.com/forum/mobile/read/2054.html">ThinkPHP3.2.3框架实现安全数据库操作分析</a>，由于接触框架比较晚，本着紧跟技术最前沿（手动滑稽）的想法，学习了TP5。之前在开发过程中遇到问题也会去看一下源码，但一直没有系统的看过TP5底层是如何保证安全的。在动手写之前上面的大佬紧接着又更新了TP5的分析<a target="_blank" rel="noopener" href="https://xianzhi.aliyun.com/forum/mobile/read/2114.html">框架filterExp函数过滤不严格导致SQL注入</a>，先膜一发，然后开始读代码。。。</p>
<span id="more"></span>


<h3 id="0x02-准备工作"><a href="#0x02-准备工作" class="headerlink" title="0x02 准备工作"></a>0x02 准备工作</h3><p>目前（2017.09.20）thinkphp官网上的最新版本是5.0.11，我们用来分析的也是这个版本。</p>
<p>测试环境为Windows + php5.5.3 + mysql + apache</p>
<p>测试代码：</p>
<p>application\index\controller\Index.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">app</span>\<span class="title class_">index</span>\<span class="title class_">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$username</span> = <span class="title function_ invoke__">input</span>(<span class="string">&#x27;post.user&#x27;</span>);</span><br><span class="line">        <span class="variable">$info</span> = <span class="title function_ invoke__">db</span>(<span class="string">&#x27;user&#x27;</span>)-&gt;<span class="title function_ invoke__">where</span>(<span class="keyword">array</span>(<span class="string">&#x27;username&#x27;</span>=&gt; <span class="variable">$username</span>))-&gt;<span class="title function_ invoke__">select</span>();</span><br><span class="line">        <span class="title function_ invoke__">var_dump</span>(<span class="variable">$info</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>解释一下这段代码，input和db这两个函数在tp5中称为<code>助手函数</code>，与TP3中的单字母函数<code>I()</code>、<code>M()</code>相对应。</p>
<p>这是官方手册：</p>
<p>input：	<a target="_blank" rel="noopener" href="https://www.kancloud.cn/manual/thinkphp5/118044">https://www.kancloud.cn/manual/thinkphp5/118044</a></p>
<p>助手函数本质上还是调用的相应的类来进行一系列操作，并没有另外进行其他的实现。</p>
<p>以db函数为例：</p>
<p>thinkphp\helper.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">function_exists</span>(<span class="string">&#x27;db&#x27;</span>)) &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 实例化数据库类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string        $name 操作的数据表名称（不含前缀）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array|string  $config 数据库配置参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bool          $force 是否强制重新连接</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> \think\db\Query</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">db</span>(<span class="params"><span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$config</span> = [], <span class="variable">$force</span> = <span class="literal">false</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Db</span>::<span class="title function_ invoke__">connect</span>(<span class="variable">$config</span>, <span class="variable">$force</span>)-&gt;<span class="title function_ invoke__">name</span>(<span class="variable">$name</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="0x03-分析"><a href="#0x03-分析" class="headerlink" title="0x03 分析"></a>0x03 分析</h3><p>前面瞎扯的有点多。。。现在我们进入正题。</p>
<p><strong>在分析代码之前，我们需要知道TP5使用了<a target="_blank" rel="noopener" href="http://php.net/manual/zh/book.pdo.php">PDO</a>预处理机制及自动参数绑定功能</strong>。这种技术号称可以完全防止sql注入，当然这是吹n*的，没有绝对的安全，但是对付一般的注入足够了。</p>
<p><img src="http://mdpicture.oss-cn-beijing.aliyuncs.com///170920/hhA95gBj20.png" alt="mark"></p>
<p>按照惯例加个单引号，不出意外被过滤了，我们不妨把<code>admin&#39;</code>看成一个小蝌蚪，看看它到底经历了什么最终进入了数据库（怎么感觉有点污呢。。。）。</p>
<h4 id="3-1-input"><a href="#3-1-input" class="headerlink" title="3.1 input()"></a>3.1 input()</h4><p>首先是input函数了：</p>
<p>thinkphp\helper.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">function_exists</span>(<span class="string">&#x27;input&#x27;</span>)) &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取输入数据 支持默认值和过滤</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string    $key 获取的变量名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mixed     $default 默认值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string    $filter 过滤方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">input</span>(<span class="params"><span class="variable">$key</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span> = <span class="literal">null</span>, <span class="variable">$filter</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">      	<span class="comment">/*</span></span><br><span class="line"><span class="comment">      	input(&#x27;?post.id&#x27;)，在不确定是否有id这个参数时使用，实际情况中很少见到</span></span><br><span class="line"><span class="comment">      	*/</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> === <span class="title function_ invoke__">strpos</span>(<span class="variable">$key</span>, <span class="string">&#x27;?&#x27;</span>)) &#123;</span><br><span class="line">            <span class="variable">$key</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$key</span>, <span class="number">1</span>);</span><br><span class="line">            <span class="variable">$has</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$pos</span> = <span class="title function_ invoke__">strpos</span>(<span class="variable">$key</span>, <span class="string">&#x27;.&#x27;</span>)) &#123;</span><br><span class="line">            <span class="comment">// 指定参数来源</span></span><br><span class="line">            <span class="keyword">list</span>(<span class="variable">$method</span>, <span class="variable">$key</span>) = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;.&#x27;</span>, <span class="variable">$key</span>, <span class="number">2</span>);</span><br><span class="line">            <span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$method</span>, [<span class="string">&#x27;get&#x27;</span>, <span class="string">&#x27;post&#x27;</span>, <span class="string">&#x27;put&#x27;</span>, <span class="string">&#x27;patch&#x27;</span>, <span class="string">&#x27;delete&#x27;</span>, <span class="string">&#x27;route&#x27;</span>, <span class="string">&#x27;param&#x27;</span>, <span class="string">&#x27;request&#x27;</span>, <span class="string">&#x27;session&#x27;</span>, <span class="string">&#x27;cookie&#x27;</span>, <span class="string">&#x27;server&#x27;</span>, <span class="string">&#x27;env&#x27;</span>, <span class="string">&#x27;path&#x27;</span>, <span class="string">&#x27;file&#x27;</span>])) &#123;</span><br><span class="line">              	<span class="comment">//如果参数来源不合法，使用自动判断</span></span><br><span class="line">                <span class="variable">$key</span>    = <span class="variable">$method</span> . <span class="string">&#x27;.&#x27;</span> . <span class="variable">$key</span>;</span><br><span class="line">                <span class="variable">$method</span> = <span class="string">&#x27;param&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 默认为自动判断</span></span><br><span class="line">            <span class="variable">$method</span> = <span class="string">&#x27;param&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$has</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">request</span>()-&gt;<span class="title function_ invoke__">has</span>(<span class="variable">$key</span>, <span class="variable">$method</span>, <span class="variable">$default</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">request</span>()-&gt;<span class="variable">$method</span>(<span class="variable">$key</span>, <span class="variable">$default</span>, <span class="variable">$filter</span>); </span><br><span class="line">          	<span class="comment">/*</span></span><br><span class="line"><span class="comment">        	我们在测试代码中指定了数据以post形式传输，这里相当于</span></span><br><span class="line"><span class="comment">        	request()-&gt;post($key, $default, $filter);</span></span><br><span class="line"><span class="comment">        	*/</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到这个函数只是将我们输入的字符串进行解析，参数是什么，用什么方法传递的（get || post || …），最后调用了另一个助手函数request，继续跟下去。request函数只是返回了一个Request类的实例化，就不贴代码了，现在来到了Request类的post方法。</p>
<h5 id="3-1-1-post"><a href="#3-1-1-post" class="headerlink" title="3.1.1 post()"></a>3.1.1 post()</h5><p>thinkphp\library\think\Request.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置获取POST参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string        $name 变量名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mixed         $default 默认值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string|array  $filter 过滤方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">post</span>(<span class="params"><span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span> = <span class="literal">null</span>, <span class="variable">$filter</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;post)) &#123;</span><br><span class="line">            <span class="variable">$content</span> = <span class="variable language_">$this</span>-&gt;input; <span class="comment">//获取php://input</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$_POST</span>) &amp;&amp; <span class="literal">false</span> !== <span class="title function_ invoke__">strpos</span>(<span class="variable">$this</span>-&gt;<span class="title function_ invoke__">contentType</span>(), <span class="string">&#x27;application/json&#x27;</span>)) &#123;</span><br><span class="line">              	<span class="comment">//处理json</span></span><br><span class="line">                <span class="variable language_">$this</span>-&gt;post = (<span class="keyword">array</span>) <span class="title function_ invoke__">json_decode</span>(<span class="variable">$content</span>, <span class="literal">true</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;post = <span class="variable">$_POST</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      	<span class="comment">//获取到的参数是数组</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$name</span>)) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;param       = [];</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;post = <span class="title function_ invoke__">array_merge</span>(<span class="variable">$this</span>-&gt;post, <span class="variable">$name</span>); <span class="comment">//合并数组</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">input</span>(<span class="variable">$this</span>-&gt;post, <span class="variable">$name</span>, <span class="variable">$default</span>, <span class="variable">$filter</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>post方法又对我们传入的参数进行了一些解析，最后将结果传入了input方法。（其实不光post方法，其他如get、param等方法最终也都进入了input方法）。到这里都是对参数进行了解析，对于我们传入的值<code>admin&#39;</code>，没有进行任何操作。。。下面重点来了：</p>
<h5 id="3-1-2-input"><a href="#3-1-2-input" class="headerlink" title="3.1.2 input()"></a>3.1.2 input()</h5><p>thinkphp\library\think\Request.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取变量 支持过滤和默认值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array         $data 数据源</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string|false  $name 字段名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mixed         $default 默认值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string|array  $filter 过滤函数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">input</span>(<span class="params"><span class="variable">$data</span> = [], <span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span> = <span class="literal">null</span>, <span class="variable">$filter</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">false</span> === <span class="variable">$name</span>) &#123;</span><br><span class="line">            <span class="comment">// 获取原始数据</span></span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$name</span> = (<span class="keyword">string</span>) <span class="variable">$name</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&#x27;&#x27;</span> != <span class="variable">$name</span>) &#123;</span><br><span class="line">            <span class="comment">/* 解析name，获取变量修饰符，这里涉及到tp5变量获取很有趣的一个功能，下面会提到，</span></span><br><span class="line"><span class="comment">               用的人也比较少</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$name</span>, <span class="string">&#x27;/&#x27;</span>)) &#123;</span><br><span class="line">                <span class="keyword">list</span>(<span class="variable">$name</span>, <span class="variable">$type</span>) = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;/&#x27;</span>, <span class="variable">$name</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$type</span> = <span class="string">&#x27;s&#x27;</span>; <span class="comment">//默认为s，即字符串类型</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 按.拆分成多维数组进行判断</span></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="title function_ invoke__">explode</span>(<span class="string">&#x27;.&#x27;</span>, <span class="variable">$name</span>) <span class="keyword">as</span> <span class="variable">$val</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$data</span>[<span class="variable">$val</span>])) &#123;</span><br><span class="line">                    <span class="variable">$data</span> = <span class="variable">$data</span>[<span class="variable">$val</span>];</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 无输入数据，返回默认值</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="variable">$default</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">is_object</span>(<span class="variable">$data</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//input支持input(&#x27;post.&#x27;)，获取所有post参数。</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 解析过滤器，可以是一个或多个过滤函数，也会读取配置文件中默认的过滤函数</span></span><br><span class="line">        <span class="comment">// input(&#x27;post.user&#x27;, &#x27;&#x27;, addslashes)</span></span><br><span class="line">        <span class="variable">$filter</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getFilter</span>(<span class="variable">$filter</span>, <span class="variable">$default</span>);</span><br><span class="line"></span><br><span class="line">      	<span class="comment">//将数据放入过滤器过滤</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$data</span>)) &#123;</span><br><span class="line">            <span class="title function_ invoke__">array_walk_recursive</span>(<span class="variable">$data</span>, [<span class="variable">$this</span>, <span class="string">&#x27;filterValue&#x27;</span>], <span class="variable">$filter</span>);</span><br><span class="line">            <span class="title function_ invoke__">reset</span>(<span class="variable">$data</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">filterValue</span>(<span class="variable">$data</span>, <span class="variable">$name</span>, <span class="variable">$filter</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$type</span>) &amp;&amp; <span class="variable">$data</span> !== <span class="variable">$default</span>) &#123;</span><br><span class="line">            <span class="comment">// 强制类型转换</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">typeCast</span>(<span class="variable">$data</span>, <span class="variable">$type</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>小蝌蚪的第一个阻碍好像来了，跟进filterValue函数看一下，贴代码之前还有个有意思的地方</p>
<p><img src="http://mdpicture.oss-cn-beijing.aliyuncs.com///170921/90KfG4g3Ka.png" alt="mark"></p>
<p>但是不要高兴的太早。。。</p>
<h5 id="3-1-3-filterValue"><a href="#3-1-3-filterValue" class="headerlink" title="3.1.3 filterValue()"></a>3.1.3 filterValue()</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 递归过滤给定的值</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> mixed     $value 键值</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> mixed     $key 键名</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> array     $filters 过滤方法+默认值</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">filterValue</span>(<span class="params">&amp;<span class="variable">$value</span>, <span class="variable">$key</span>, <span class="variable">$filters</span></span>)</span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="variable">$default</span> = <span class="title function_ invoke__">array_pop</span>(<span class="variable">$filters</span>);</span><br><span class="line">       <span class="keyword">foreach</span> (<span class="variable">$filters</span> <span class="keyword">as</span> <span class="variable">$filter</span>) &#123;</span><br><span class="line">           <span class="keyword">if</span> (<span class="title function_ invoke__">is_callable</span>(<span class="variable">$filter</span>)) &#123;</span><br><span class="line">               <span class="comment">// 调用函数或者方法过滤</span></span><br><span class="line">               <span class="variable">$value</span> = <span class="title function_ invoke__">call_user_func</span>(<span class="variable">$filter</span>, <span class="variable">$value</span>);</span><br><span class="line">           &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">is_scalar</span>(<span class="variable">$value</span>)) &#123; <span class="comment">//int, float, string, bool</span></span><br><span class="line">               <span class="keyword">if</span> (<span class="literal">false</span> !== <span class="title function_ invoke__">strpos</span>(<span class="variable">$filter</span>, <span class="string">&#x27;/&#x27;</span>)) &#123;</span><br><span class="line">                   <span class="comment">// 正则过滤</span></span><br><span class="line">                   <span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="variable">$filter</span>, <span class="variable">$value</span>)) &#123;</span><br><span class="line">                       <span class="comment">// 匹配不成功返回默认值</span></span><br><span class="line">                       <span class="variable">$value</span> = <span class="variable">$default</span>;</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125; <span class="keyword">elseif</span> (!<span class="keyword">empty</span>(<span class="variable">$filter</span>)) &#123;</span><br><span class="line">                   <span class="comment">// filter函数不存在时, 则使用filter_var进行过滤</span></span><br><span class="line">                   <span class="comment">// filter为非整形值时, 调用filter_id取得过滤id</span></span><br><span class="line">                   <span class="variable">$value</span> = <span class="title function_ invoke__">filter_var</span>(<span class="variable">$value</span>, <span class="title function_ invoke__">is_int</span>(<span class="variable">$filter</span>) ? <span class="variable">$filter</span> : <span class="title function_ invoke__">filter_id</span>(<span class="variable">$filter</span>));</span><br><span class="line">                   <span class="keyword">if</span> (<span class="literal">false</span> === <span class="variable">$value</span>) &#123;</span><br><span class="line">                       <span class="variable">$value</span> = <span class="variable">$default</span>;</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//即使配置文件以及开发者都没有设置过滤函数，这里依然会过滤一次</span></span><br><span class="line">       <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">filterExp</span>(<span class="variable">$value</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>这个函数注释写的比较明白，如果配置文件以及开发者都没有设置过滤函数的话，就直接走到最后了，现在跟进filterExp方法。</p>
<h5 id="3-1-4-filterExp"><a href="#3-1-4-filterExp" class="headerlink" title="3.1.4 filterExp() *"></a>3.1.4 filterExp() *</h5><p>thinkphp\library\think\Request.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">filterExp</span>(<span class="params">&amp;<span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// 过滤查询特殊字符</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_ invoke__">is_string</span>(<span class="variable">$value</span>) &amp;&amp; <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^(EXP|NEQ|GT|EGT|LT|ELT|OR|XOR|LIKE|NOTLIKE|NOT LIKE|NOT BETWEEN|NOTBETWEEN|BETWEEN|NOTIN|NOT IN|IN)$/i&#x27;</span>, <span class="variable">$value</span>)) &#123;</span><br><span class="line">    <span class="variable">$value</span> .= <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// TODO 其他安全过滤</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数很简单，匹配一些敏感关键字，如果匹配到的话，就在关键字后面加一个空格。这么做有啥用？这个地方在这里很难说清楚，需要结合后面，我们先记一下。</p>
<p>到这里input之旅就结束了，虽然经过了一些奇奇怪怪的过滤，但是似乎并没有威胁到单引号，事实上如果没有修改配置文件，仅仅靠<code>input(&#39;post.user&#39;)</code>是无法过滤单引号的（由于pdo的存在，其实完全没必要）。</p>
<p><img src="http://mdpicture.oss-cn-beijing.aliyuncs.com///170921/emhk7egAaH.png" alt="mark"></p>
<p>这里虽然没有sql注入的威胁，但是<strong>什么过滤都不加会导致xss。</strong></p>
<h4 id="3-2-select"><a href="#3-2-select" class="headerlink" title="3.2 select()"></a>3.2 select()</h4><p>从我们在控制器中调用到函数执行走了这么多文件。。。</p>
<p><img src="http://mdpicture.oss-cn-beijing.aliyuncs.com///170921/f5A5IH8iDm.png" alt="mark"></p>
<p>要搞懂这一连串的调用真有点不容易。。。用一张图片来说明吧</p>
<p><img src="http://mdpicture.oss-cn-beijing.aliyuncs.com///170925/L84a167cAG.png" alt="mark"></p>
<p>通过分析流程我们知道对我们输入的数据进行过滤等操作的地方是在<code>thinkphp\library\think\db\Builder.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成查询SQL</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array $options 表达式</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">select</span>(<span class="params"><span class="variable">$options</span> = []</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$sql</span> = <span class="title function_ invoke__">str_replace</span>(</span><br><span class="line">            [<span class="string">&#x27;%TABLE%&#x27;</span>, <span class="string">&#x27;%DISTINCT%&#x27;</span>, <span class="string">&#x27;%FIELD%&#x27;</span>, <span class="string">&#x27;%JOIN%&#x27;</span>, <span class="string">&#x27;%WHERE%&#x27;</span>, <span class="string">&#x27;%GROUP%&#x27;</span>, <span class="string">&#x27;%HAVING%&#x27;</span>, <span class="string">&#x27;%ORDER%&#x27;</span>, <span class="string">&#x27;%LIMIT%&#x27;</span>, <span class="string">&#x27;%UNION%&#x27;</span>, <span class="string">&#x27;%LOCK%&#x27;</span>, <span class="string">&#x27;%COMMENT%&#x27;</span>, <span class="string">&#x27;%FORCE%&#x27;</span>],</span><br><span class="line">            [</span><br><span class="line">                <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">parseTable</span>(<span class="variable">$options</span>[<span class="string">&#x27;table&#x27;</span>], <span class="variable">$options</span>),</span><br><span class="line">                <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">parseDistinct</span>(<span class="variable">$options</span>[<span class="string">&#x27;distinct&#x27;</span>]),</span><br><span class="line">                <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">parseField</span>(<span class="variable">$options</span>[<span class="string">&#x27;field&#x27;</span>], <span class="variable">$options</span>),</span><br><span class="line">                <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">parseJoin</span>(<span class="variable">$options</span>[<span class="string">&#x27;join&#x27;</span>], <span class="variable">$options</span>),</span><br><span class="line">                <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">parseWhere</span>(<span class="variable">$options</span>[<span class="string">&#x27;where&#x27;</span>], <span class="variable">$options</span>), //我是重点</span><br><span class="line">                <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">parseGroup</span>(<span class="variable">$options</span>[<span class="string">&#x27;group&#x27;</span>]),</span><br><span class="line">                <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">parseHaving</span>(<span class="variable">$options</span>[<span class="string">&#x27;having&#x27;</span>]),</span><br><span class="line">                <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">parseOrder</span>(<span class="variable">$options</span>[<span class="string">&#x27;order&#x27;</span>], <span class="variable">$options</span>),</span><br><span class="line">                <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">parseLimit</span>(<span class="variable">$options</span>[<span class="string">&#x27;limit&#x27;</span>]),</span><br><span class="line">                <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">parseUnion</span>(<span class="variable">$options</span>[<span class="string">&#x27;union&#x27;</span>]),</span><br><span class="line">                <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">parseLock</span>(<span class="variable">$options</span>[<span class="string">&#x27;lock&#x27;</span>]),</span><br><span class="line">                <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">parseComment</span>(<span class="variable">$options</span>[<span class="string">&#x27;comment&#x27;</span>]),</span><br><span class="line">                <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">parseForce</span>(<span class="variable">$options</span>[<span class="string">&#x27;force&#x27;</span>]),</span><br><span class="line">            ], <span class="variable">$this</span>-&gt;selectSql);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$sql</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="3-2-1-parseWhere"><a href="#3-2-1-parseWhere" class="headerlink" title="3.2.1 parseWhere()"></a>3.2.1 parseWhere()</h5><p>跟进parseWhere函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * where分析</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@access</span> protected</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> mixed $where   查询条件</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> array $options 查询参数</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseWhere</span>(<span class="params"><span class="variable">$where</span>, <span class="variable">$options</span></span>)</span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="variable">$whereStr</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">buildWhere</span>(<span class="variable">$where</span>, <span class="variable">$options</span>); <span class="comment">//*</span></span><br><span class="line">       <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;soft_delete&#x27;</span>])) &#123;</span><br><span class="line">           <span class="comment">// 附加软删除条件</span></span><br><span class="line">           <span class="keyword">list</span>(<span class="variable">$field</span>, <span class="variable">$condition</span>) = <span class="variable">$options</span>[<span class="string">&#x27;soft_delete&#x27;</span>];</span><br><span class="line"></span><br><span class="line">           <span class="variable">$binds</span>    = <span class="variable language_">$this</span>-&gt;query-&gt;<span class="title function_ invoke__">getFieldsBind</span>(<span class="variable">$options</span>[<span class="string">&#x27;table&#x27;</span>]);</span><br><span class="line">           <span class="variable">$whereStr</span> = <span class="variable">$whereStr</span> ? <span class="string">&#x27;( &#x27;</span> . <span class="variable">$whereStr</span> . <span class="string">&#x27; ) AND &#x27;</span> : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">           <span class="variable">$whereStr</span> = <span class="variable">$whereStr</span> . <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseWhereItem</span>(<span class="variable">$field</span>, <span class="variable">$condition</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$options</span>, <span class="variable">$binds</span>); <span class="comment">//*</span></span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">empty</span>(<span class="variable">$whereStr</span>) ? <span class="string">&#x27;&#x27;</span> : <span class="string">&#x27; WHERE &#x27;</span> . <span class="variable">$whereStr</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>我们输入的字符串先后进入了buildWhere和parseWhereItem方法，首先跟进buildWhere方法，发现其内部也是调用了parseWhereItem方法，我们直接来看这个方法。</p>
<h5 id="3-2-2-parseWhereItem"><a href="#3-2-2-parseWhereItem" class="headerlink" title="3.2.2 parseWhereItem()"></a>3.2.2 parseWhereItem()</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// where子单元分析</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseWhereItem</span>(<span class="params"><span class="variable">$field</span>, <span class="variable">$val</span>, <span class="variable">$rule</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$options</span> = [], <span class="variable">$binds</span> = [], <span class="variable">$bindName</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 字段分析</span></span><br><span class="line">        <span class="variable">$key</span> = <span class="variable">$field</span> ? <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseKey</span>(<span class="variable">$field</span>, <span class="variable">$options</span>) : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 查询规则和条件</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">is_array</span>(<span class="variable">$val</span>)) &#123;</span><br><span class="line">            <span class="variable">$val</span> = <span class="title function_ invoke__">is_null</span>(<span class="variable">$val</span>) ? [<span class="string">&#x27;null&#x27;</span>, <span class="string">&#x27;&#x27;</span>] : [<span class="string">&#x27;=&#x27;</span>, <span class="variable">$val</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">list</span>(<span class="variable">$exp</span>, <span class="variable">$value</span>) = <span class="variable">$val</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 对一个字段使用多个查询条件</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$exp</span>)) &#123;</span><br><span class="line">            <span class="variable">$item</span> = <span class="title function_ invoke__">array_pop</span>(<span class="variable">$val</span>);</span><br><span class="line">            <span class="comment">// 传入 or 或者 and</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">is_string</span>(<span class="variable">$item</span>) &amp;&amp; <span class="title function_ invoke__">in_array</span>(<span class="variable">$item</span>, [<span class="string">&#x27;AND&#x27;</span>, <span class="string">&#x27;and&#x27;</span>, <span class="string">&#x27;OR&#x27;</span>, <span class="string">&#x27;or&#x27;</span>])) &#123;</span><br><span class="line">                <span class="variable">$rule</span> = <span class="variable">$item</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="title function_ invoke__">array_push</span>(<span class="variable">$val</span>, <span class="variable">$item</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$val</span> <span class="keyword">as</span> <span class="variable">$k</span> =&gt; <span class="variable">$item</span>) &#123;</span><br><span class="line">                <span class="variable">$bindName</span> = <span class="string">&#x27;where_&#x27;</span> . <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;_&#x27;</span>, <span class="variable">$field</span>) . <span class="string">&#x27;_&#x27;</span> . <span class="variable">$k</span>;</span><br><span class="line">                <span class="variable">$str</span>[]    = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseWhereItem</span>(<span class="variable">$field</span>, <span class="variable">$item</span>, <span class="variable">$rule</span>, <span class="variable">$options</span>, <span class="variable">$binds</span>, <span class="variable">$bindName</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;( &#x27;</span> . <span class="title function_ invoke__">implode</span>(<span class="string">&#x27; &#x27;</span> . <span class="variable">$rule</span> . <span class="string">&#x27; &#x27;</span>, <span class="variable">$str</span>) . <span class="string">&#x27; )&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 检测操作符</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$exp</span>, <span class="variable">$this</span>-&gt;exp)) &#123;</span><br><span class="line">            <span class="variable">$exp</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$exp</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;exp[<span class="variable">$exp</span>])) &#123;</span><br><span class="line">                <span class="variable">$exp</span> = <span class="variable language_">$this</span>-&gt;exp[<span class="variable">$exp</span>];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&#x27;where express error:&#x27;</span> . <span class="variable">$exp</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$bindName</span> = <span class="variable">$bindName</span> ?: <span class="string">&#x27;where_&#x27;</span> . <span class="title function_ invoke__">str_replace</span>([<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;-&#x27;</span>], <span class="string">&#x27;_&#x27;</span>, <span class="variable">$field</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/\W/&#x27;</span>, <span class="variable">$bindName</span>)) &#123;</span><br><span class="line">            <span class="comment">// 处理带非单词字符的字段名</span></span><br><span class="line">            <span class="variable">$bindName</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$bindName</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_object</span>(<span class="variable">$value</span>) &amp;&amp; <span class="title function_ invoke__">method_exists</span>(<span class="variable">$value</span>, <span class="string">&#x27;__toString&#x27;</span>)) &#123;</span><br><span class="line">            <span class="comment">// 对象数据写入</span></span><br><span class="line">            <span class="variable">$value</span> = <span class="variable">$value</span>-&gt;<span class="title function_ invoke__">__toString</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$bindType</span> = <span class="keyword">isset</span>(<span class="variable">$binds</span>[<span class="variable">$field</span>]) ? <span class="variable">$binds</span>[<span class="variable">$field</span>] : PDO::<span class="variable constant_">PARAM_STR</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_scalar</span>(<span class="variable">$value</span>) &amp;&amp; <span class="title function_ invoke__">array_key_exists</span>(<span class="variable">$field</span>, <span class="variable">$binds</span>) &amp;&amp; !<span class="title function_ invoke__">in_array</span>(<span class="variable">$exp</span>, [<span class="string">&#x27;EXP&#x27;</span>, <span class="string">&#x27;NOT NULL&#x27;</span>, <span class="string">&#x27;NULL&#x27;</span>, <span class="string">&#x27;IN&#x27;</span>, <span class="string">&#x27;NOT IN&#x27;</span>, <span class="string">&#x27;BETWEEN&#x27;</span>, <span class="string">&#x27;NOT BETWEEN&#x27;</span>]) &amp;&amp; <span class="title function_ invoke__">strpos</span>(<span class="variable">$exp</span>, <span class="string">&#x27;TIME&#x27;</span>) === <span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$value</span>, <span class="string">&#x27;:&#x27;</span>) !== <span class="number">0</span> || !<span class="variable language_">$this</span>-&gt;query-&gt;<span class="title function_ invoke__">isBind</span>(<span class="title function_ invoke__">substr</span>(<span class="variable">$value</span>, <span class="number">1</span>))) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;query-&gt;<span class="title function_ invoke__">isBind</span>(<span class="variable">$bindName</span>)) &#123;</span><br><span class="line">                    <span class="variable">$bindName</span> .= <span class="string">&#x27;_&#x27;</span> . <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;_&#x27;</span>, <span class="title function_ invoke__">uniqid</span>(<span class="string">&#x27;&#x27;</span>, <span class="literal">true</span>));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;query-&gt;<span class="title function_ invoke__">bind</span>(<span class="variable">$bindName</span>, <span class="variable">$value</span>, <span class="variable">$bindType</span>); <span class="comment">/** pdo参数绑定 **/</span></span><br><span class="line">                <span class="variable">$value</span> = <span class="string">&#x27;:&#x27;</span> . <span class="variable">$bindName</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$whereStr</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$exp</span>, [<span class="string">&#x27;=&#x27;</span>, <span class="string">&#x27;&lt;&gt;&#x27;</span>, <span class="string">&#x27;&gt;&#x27;</span>, <span class="string">&#x27;&gt;=&#x27;</span>, <span class="string">&#x27;&lt;&#x27;</span>, <span class="string">&#x27;&lt;=&#x27;</span>])) &#123;</span><br><span class="line">            <span class="comment">// 比较运算</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$value</span> <span class="keyword">instanceof</span> \<span class="built_in">Closure</span>) &#123;</span><br><span class="line">                <span class="variable">$whereStr</span> .= <span class="variable">$key</span> . <span class="string">&#x27; &#x27;</span> . <span class="variable">$exp</span> . <span class="string">&#x27; &#x27;</span> . <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseClosure</span>(<span class="variable">$value</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$whereStr</span> .= <span class="variable">$key</span> . <span class="string">&#x27; &#x27;</span> . <span class="variable">$exp</span> . <span class="string">&#x27; &#x27;</span> . <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseValue</span>(<span class="variable">$value</span>, <span class="variable">$field</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="string">&#x27;LIKE&#x27;</span> == <span class="variable">$exp</span> || <span class="string">&#x27;NOT LIKE&#x27;</span> == <span class="variable">$exp</span>) &#123;</span><br><span class="line">            <span class="comment">// 模糊匹配</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$value</span>)) &#123;</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="variable">$value</span> <span class="keyword">as</span> <span class="variable">$item</span>) &#123;</span><br><span class="line">                    <span class="variable">$array</span>[] = <span class="variable">$key</span> . <span class="string">&#x27; &#x27;</span> . <span class="variable">$exp</span> . <span class="string">&#x27; &#x27;</span> . <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseValue</span>(<span class="variable">$item</span>, <span class="variable">$field</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="variable">$logic</span> = <span class="keyword">isset</span>(<span class="variable">$val</span>[<span class="number">2</span>]) ? <span class="variable">$val</span>[<span class="number">2</span>] : <span class="string">&#x27;AND&#x27;</span>;</span><br><span class="line">                <span class="variable">$whereStr</span> .= <span class="string">&#x27;(&#x27;</span> . <span class="title function_ invoke__">implode</span>(<span class="variable">$array</span>, <span class="string">&#x27; &#x27;</span> . <span class="title function_ invoke__">strtoupper</span>(<span class="variable">$logic</span>) . <span class="string">&#x27; &#x27;</span>) . <span class="string">&#x27;)&#x27;</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$whereStr</span> .= <span class="variable">$key</span> . <span class="string">&#x27; &#x27;</span> . <span class="variable">$exp</span> . <span class="string">&#x27; &#x27;</span> . <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseValue</span>(<span class="variable">$value</span>, <span class="variable">$field</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="string">&#x27;EXP&#x27;</span> == <span class="variable">$exp</span>) &#123;</span><br><span class="line">            <span class="comment">// 表达式查询</span></span><br><span class="line">            <span class="variable">$whereStr</span> .= <span class="string">&#x27;( &#x27;</span> . <span class="variable">$key</span> . <span class="string">&#x27; &#x27;</span> . <span class="variable">$value</span> . <span class="string">&#x27; )&#x27;</span>;</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$exp</span>, [<span class="string">&#x27;NOT NULL&#x27;</span>, <span class="string">&#x27;NULL&#x27;</span>])) &#123;</span><br><span class="line">            <span class="comment">// NULL 查询</span></span><br><span class="line">            <span class="variable">$whereStr</span> .= <span class="variable">$key</span> . <span class="string">&#x27; IS &#x27;</span> . <span class="variable">$exp</span>;</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$exp</span>, [<span class="string">&#x27;NOT IN&#x27;</span>, <span class="string">&#x27;IN&#x27;</span>])) &#123;</span><br><span class="line">            <span class="comment">// IN 查询</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$value</span> <span class="keyword">instanceof</span> \<span class="built_in">Closure</span>) &#123;</span><br><span class="line">                <span class="variable">$whereStr</span> .= <span class="variable">$key</span> . <span class="string">&#x27; &#x27;</span> . <span class="variable">$exp</span> . <span class="string">&#x27; &#x27;</span> . <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseClosure</span>(<span class="variable">$value</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$value</span> = <span class="title function_ invoke__">array_unique</span>(<span class="title function_ invoke__">is_array</span>(<span class="variable">$value</span>) ? <span class="variable">$value</span> : <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$value</span>));</span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_ invoke__">array_key_exists</span>(<span class="variable">$field</span>, <span class="variable">$binds</span>)) &#123;</span><br><span class="line">                    <span class="variable">$bind</span>  = [];</span><br><span class="line">                    <span class="variable">$array</span> = [];</span><br><span class="line">                    <span class="variable">$i</span>     = <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">foreach</span> (<span class="variable">$value</span> <span class="keyword">as</span> <span class="variable">$v</span>) &#123;</span><br><span class="line">                        <span class="variable">$i</span>++;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;query-&gt;<span class="title function_ invoke__">isBind</span>(<span class="variable">$bindName</span> . <span class="string">&#x27;_in_&#x27;</span> . <span class="variable">$i</span>)) &#123;</span><br><span class="line">                            <span class="variable">$bindKey</span> = <span class="variable">$bindName</span> . <span class="string">&#x27;_in_&#x27;</span> . <span class="title function_ invoke__">uniqid</span>() . <span class="string">&#x27;_&#x27;</span> . <span class="variable">$i</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="variable">$bindKey</span> = <span class="variable">$bindName</span> . <span class="string">&#x27;_in_&#x27;</span> . <span class="variable">$i</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="variable">$bind</span>[<span class="variable">$bindKey</span>] = [<span class="variable">$v</span>, <span class="variable">$bindType</span>];</span><br><span class="line">                        <span class="variable">$array</span>[]        = <span class="string">&#x27;:&#x27;</span> . <span class="variable">$bindKey</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="variable language_">$this</span>-&gt;query-&gt;<span class="title function_ invoke__">bind</span>(<span class="variable">$bind</span>);</span><br><span class="line">                    <span class="variable">$zone</span> = <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$array</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable">$zone</span> = <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">parseValue</span>(<span class="variable">$value</span>, <span class="variable">$field</span>));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="variable">$whereStr</span> .= <span class="variable">$key</span> . <span class="string">&#x27; &#x27;</span> . <span class="variable">$exp</span> . <span class="string">&#x27; (&#x27;</span> . (<span class="keyword">empty</span>(<span class="variable">$zone</span>) ? <span class="string">&quot;&#x27;&#x27;&quot;</span> : <span class="variable">$zone</span>) . <span class="string">&#x27;)&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$exp</span>, [<span class="string">&#x27;NOT BETWEEN&#x27;</span>, <span class="string">&#x27;BETWEEN&#x27;</span>])) &#123;</span><br><span class="line">            <span class="comment">// BETWEEN 查询</span></span><br><span class="line">            <span class="variable">$data</span> = <span class="title function_ invoke__">is_array</span>(<span class="variable">$value</span>) ? <span class="variable">$value</span> : <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$value</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">array_key_exists</span>(<span class="variable">$field</span>, <span class="variable">$binds</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;query-&gt;<span class="title function_ invoke__">isBind</span>(<span class="variable">$bindName</span> . <span class="string">&#x27;_between_1&#x27;</span>)) &#123;</span><br><span class="line">                    <span class="variable">$bindKey1</span> = <span class="variable">$bindName</span> . <span class="string">&#x27;_between_1&#x27;</span> . <span class="title function_ invoke__">uniqid</span>();</span><br><span class="line">                    <span class="variable">$bindKey2</span> = <span class="variable">$bindName</span> . <span class="string">&#x27;_between_2&#x27;</span> . <span class="title function_ invoke__">uniqid</span>();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable">$bindKey1</span> = <span class="variable">$bindName</span> . <span class="string">&#x27;_between_1&#x27;</span>;</span><br><span class="line">                    <span class="variable">$bindKey2</span> = <span class="variable">$bindName</span> . <span class="string">&#x27;_between_2&#x27;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="variable">$bind</span> = [</span><br><span class="line">                    <span class="variable">$bindKey1</span> =&gt; [<span class="variable">$data</span>[<span class="number">0</span>], <span class="variable">$bindType</span>],</span><br><span class="line">                    <span class="variable">$bindKey2</span> =&gt; [<span class="variable">$data</span>[<span class="number">1</span>], <span class="variable">$bindType</span>],</span><br><span class="line">                ];</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;query-&gt;<span class="title function_ invoke__">bind</span>(<span class="variable">$bind</span>);</span><br><span class="line">                <span class="variable">$between</span> = <span class="string">&#x27;:&#x27;</span> . <span class="variable">$bindKey1</span> . <span class="string">&#x27; AND :&#x27;</span> . <span class="variable">$bindKey2</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$between</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseValue</span>(<span class="variable">$data</span>[<span class="number">0</span>], <span class="variable">$field</span>) . <span class="string">&#x27; AND &#x27;</span> . <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseValue</span>(<span class="variable">$data</span>[<span class="number">1</span>], <span class="variable">$field</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$whereStr</span> .= <span class="variable">$key</span> . <span class="string">&#x27; &#x27;</span> . <span class="variable">$exp</span> . <span class="string">&#x27; &#x27;</span> . <span class="variable">$between</span>;</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$exp</span>, [<span class="string">&#x27;NOT EXISTS&#x27;</span>, <span class="string">&#x27;EXISTS&#x27;</span>])) &#123;</span><br><span class="line">            <span class="comment">// EXISTS 查询</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$value</span> <span class="keyword">instanceof</span> \<span class="built_in">Closure</span>) &#123;</span><br><span class="line">                <span class="variable">$whereStr</span> .= <span class="variable">$exp</span> . <span class="string">&#x27; &#x27;</span> . <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseClosure</span>(<span class="variable">$value</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$whereStr</span> .= <span class="variable">$exp</span> . <span class="string">&#x27; (&#x27;</span> . <span class="variable">$value</span> . <span class="string">&#x27;)&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$exp</span>, [<span class="string">&#x27;&lt; TIME&#x27;</span>, <span class="string">&#x27;&gt; TIME&#x27;</span>, <span class="string">&#x27;&lt;= TIME&#x27;</span>, <span class="string">&#x27;&gt;= TIME&#x27;</span>])) &#123;</span><br><span class="line">            <span class="variable">$whereStr</span> .= <span class="variable">$key</span> . <span class="string">&#x27; &#x27;</span> . <span class="title function_ invoke__">substr</span>(<span class="variable">$exp</span>, <span class="number">0</span>, <span class="number">2</span>) . <span class="string">&#x27; &#x27;</span> . <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseDateTime</span>(<span class="variable">$value</span>, <span class="variable">$field</span>, <span class="variable">$options</span>, <span class="variable">$bindName</span>, <span class="variable">$bindType</span>);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$exp</span>, [<span class="string">&#x27;BETWEEN TIME&#x27;</span>, <span class="string">&#x27;NOT BETWEEN TIME&#x27;</span>])) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">is_string</span>(<span class="variable">$value</span>)) &#123;</span><br><span class="line">                <span class="variable">$value</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$value</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$whereStr</span> .= <span class="variable">$key</span> . <span class="string">&#x27; &#x27;</span> . <span class="title function_ invoke__">substr</span>(<span class="variable">$exp</span>, <span class="number">0</span>, -<span class="number">4</span>) . <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseDateTime</span>(<span class="variable">$value</span>[<span class="number">0</span>], <span class="variable">$field</span>, <span class="variable">$options</span>, <span class="variable">$bindName</span> . <span class="string">&#x27;_between_1&#x27;</span>, <span class="variable">$bindType</span>) . <span class="string">&#x27; AND &#x27;</span> . <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseDateTime</span>(<span class="variable">$value</span>[<span class="number">1</span>], <span class="variable">$field</span>, <span class="variable">$options</span>, <span class="variable">$bindName</span> . <span class="string">&#x27;_between_2&#x27;</span>, <span class="variable">$bindType</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$whereStr</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>一个长到爆炸的方法，还好注释是中文而且写的十分详细。。。在这个方法中实现了pdo的参数绑定（bind方法），结合注释看一下代码，发现数据基本要过parseValue这个方法，跟进去看一下。</p>
<h5 id="3-2-3-parseValue"><a href="#3-2-3-parseValue" class="headerlink" title="3.2.3 parseValue()"></a>3.2.3 parseValue()</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * value分析</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@access</span> protected</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mixed     $value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string    $field</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string|array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseValue</span>(<span class="params"><span class="variable">$value</span>, <span class="variable">$field</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_string</span>(<span class="variable">$value</span>)) &#123;</span><br><span class="line">            <span class="variable">$value</span> = <span class="title function_ invoke__">strpos</span>(<span class="variable">$value</span>, <span class="string">&#x27;:&#x27;</span>) === <span class="number">0</span> &amp;&amp; <span class="variable language_">$this</span>-&gt;query-&gt;<span class="title function_ invoke__">isBind</span>(<span class="title function_ invoke__">substr</span>(<span class="variable">$value</span>, <span class="number">1</span>)) ? <span class="variable">$value</span> : <span class="variable language_">$this</span>-&gt;connection-&gt;<span class="title function_ invoke__">quote</span>(<span class="variable">$value</span>);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$value</span>)) &#123;</span><br><span class="line">            <span class="variable">$value</span> = <span class="title function_ invoke__">array_map</span>([<span class="variable">$this</span>, <span class="string">&#x27;parseValue&#x27;</span>], <span class="variable">$value</span>);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">is_bool</span>(<span class="variable">$value</span>)) &#123;</span><br><span class="line">            <span class="variable">$value</span> = <span class="variable">$value</span> ? <span class="string">&#x27;1&#x27;</span> : <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">is_null</span>(<span class="variable">$value</span>)) &#123;</span><br><span class="line">            <span class="variable">$value</span> = <span class="string">&#x27;null&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$value</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这里的<a target="_blank" rel="noopener" href="http://php.net/manual/zh/pdo.quote.php">quote</a>方法并不是tp框架实现的，而是pdo自带的一个方法，具体功能看手册吧。</p>
<p>到这里，我们的查询语句的解析、参数的过滤、sql语句的组装全部都结束了，将组装好的sql语句返回到Query类中执行，我们输入的<code>admin&#39;</code>，最终到达了数据库。</p>
<h5 id="3-2-4-回到filterExp"><a href="#3-2-4-回到filterExp" class="headerlink" title="3.2.4 回到filterExp()"></a>3.2.4 回到filterExp()</h5><p>在最前面也说过了，TP5采用了pdo来操作数据库，一般的注入根本不起作用，现在修改一下测试代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">app</span>\<span class="title class_">index</span>\<span class="title class_">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test1</span>(<span class="params"><span class="variable">$user</span></span>) //可以接受数组、字符串等形式的<span class="title">GET</span>参数 </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//$username = input(&#x27;post.user/a&#x27;); //非常少见</span></span><br><span class="line">        <span class="variable">$info</span> = <span class="title function_ invoke__">db</span>(<span class="string">&#x27;user&#x27;</span>)-&gt;<span class="title function_ invoke__">where</span>(<span class="keyword">array</span>(<span class="string">&#x27;username&#x27;</span>=&gt; <span class="variable">$user</span>))-&gt;<span class="title function_ invoke__">select</span>();</span><br><span class="line">        <span class="title function_ invoke__">var_dump</span>(<span class="variable">$info</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>php中参数可以用数组的形式传递，TP5接收这种类型的参数有两种方式，一种是通过方法的形参来接收，另一种是用input函数，前者用的比较多，后者基本没见过。</p>
<p>在正式开始之前，先来看一下TP5是如何做到直接通过形参来接受请求参数的，这种骚操作叫<a target="_blank" rel="noopener" href="https://www.kancloud.cn/manual/thinkphp5/118043">参数绑定</a>。</p>
<p>这个不是这次的重点，粗略的画个图：</p>
<p><img src="http://mdpicture.oss-cn-beijing.aliyuncs.com///171001/65kdIG55LA.png" alt="mark"></p>
<p><code>thinkphp\library\think\App.php</code>的bindParam方法直接调用了Request中的param方法（自动判断请求类型），再往后就和我们之前的分析相同了。这里没有经过助手函数input，也就不存在类型问题，字符串、数组照单全收。这趟走下来，对TP5的运行流程也会有一个比较清晰的认识了。</p>
<p>有瞎扯了这么多，下面进入正题。我们在开发过程中对数据库的查询会有许多条件运算，不仅仅是上面最简单的相等（&#x3D;）运算，还有其他如<code>LIKE</code>、<code>IN</code>、<code>BETWEEN</code>等等其他运算。如果我们控制器的方法允许传入数组，在上面这个例子中，进行什么样的条件运算就是可控的了。</p>
<p><img src="http://mdpicture.oss-cn-beijing.aliyuncs.com///170930/L4FgbbFLjh.png" alt="mark"></p>
<p>注意传递的参数要和方法中的形参保持一致，这样传递参数理想情况下得到的sql语句应该是这样的：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `<span class="keyword">user</span>` <span class="keyword">WHERE</span> (</span><br><span class="line">  							`username` <span class="keyword">NOT</span> <span class="keyword">LIKE</span> #<span class="keyword">user</span>[<span class="number">0</span>] </span><br><span class="line">  							<span class="string">&#x27;123&#x27;</span> 				#<span class="keyword">user</span>[<span class="number">1</span>][<span class="number">0</span>]</span><br><span class="line">                            <span class="keyword">AND</span> 				#<span class="keyword">user</span>[<span class="number">2</span>] 无引号包裹，可控</span><br><span class="line">                            `username` <span class="keyword">NOT</span> <span class="keyword">LIKE</span> #<span class="keyword">user</span>[<span class="number">0</span>]</span><br><span class="line">  							<span class="string">&#x27;456&#x27;</span>				#<span class="keyword">user</span>[<span class="number">1</span>][<span class="number">1</span>]</span><br><span class="line">						   )</span><br></pre></td></tr></table></figure>

<p>我们注意到在parseWhere方法中解析条件运算的部分并没有做任何特殊符号的过滤，一切都是那么的美好，但是。。。它报错了。。报错了。。。</p>
<p>这里就要归功于之前我们记下的<strong>filterExp</strong>方法了，还记得它吗？它将一些运算符匹配出来，在后面加了一个空格，来到parseWhereItem方法时，会经历这样一个过程：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检测操作符</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$exp</span>, <span class="variable">$this</span>-&gt;exp)) &#123;</span><br><span class="line">    <span class="variable">$exp</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$exp</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;exp[<span class="variable">$exp</span>])) &#123;</span><br><span class="line">      	<span class="variable">$exp</span> = <span class="variable language_">$this</span>-&gt;exp[<span class="variable">$exp</span>];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      	<span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&#x27;where express error:&#x27;</span> . <span class="variable">$exp</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果传过来的运算符不在框架指定的运算符中，就会报错，这里我们传入的运算符后面被加了一个空格，当然是匹配不到的，所以报错。注入什么的，也不用想了。</p>
<h4 id="3-3-番外"><a href="#3-3-番外" class="headerlink" title="3.3 番外"></a>3.3 番外</h4><p>到这里，该说的差不多都说完了，但是TP5操作数据库并不只有上面这一种方法，还有另外一种比较常用的就是使用Model+ORM。我个人也比较喜欢用这种方法，因为它跟我理解的mvc模式比较相近。</p>
<p>这里多说一句有关orm的：</p>
<blockquote>
<p>ORM 的基本特性就是表映射到记录，记录映射到对象，字段映射到对象属性。模型是一种对象化的操作 封装，而不是简单的 CURD 操作，简单的 CURD 操作直接使用前面提过的 Db 类即可</p>
</blockquote>
<p>显然ORM是一种更高级的用法，即使完全不懂sql语句，也可以与操作数据库。</p>
<p>在修改测试代码之前我们需要先创建<code>app\index\model\User</code>类：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">app</span>\<span class="title class_">index</span>\<span class="title class_">model</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span> </span>&#123;</span><br><span class="line">	<span class="comment">//无特殊需要留空即可</span></span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>接着修改测试代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">app</span>\<span class="title class_">index</span>\<span class="title class_">controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Db</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">app</span>\<span class="title">index</span>\<span class="title">model</span>\<span class="title">User</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$username</span> = <span class="title function_ invoke__">input</span>(<span class="string">&#x27;post.username&#x27;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="variable">$user</span> = <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        <span class="comment">//$user = model(&#x27;user&#x27;); //不需要单独写一个model类</span></span><br><span class="line">        </span><br><span class="line">        <span class="variable">$info</span> = <span class="variable">$user</span>-&gt;<span class="title function_ invoke__">get</span>([<span class="string">&#x27;username&#x27;</span>=&gt; <span class="variable">$username</span>]); <span class="comment">//获取一条数据，all为获取所有</span></span><br><span class="line">        <span class="comment">//$info = $user-&gt;where([&#x27;username&#x27;=&gt; $username])-&gt;select();</span></span><br><span class="line">        <span class="comment">//$info = $user-&gt;getByUsername($username);</span></span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">var_dump</span>(<span class="variable">$info</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有好多种使用方式，只写了几个常用的，还有一些。。条条大路通罗马。。。</p>
<p><img src="http://mdpicture.oss-cn-beijing.aliyuncs.com///171002/k1EEHHG7DG.png" alt="mark"></p>
<p>通过对经过的文件的分析，我们可以看到调用过程和前面是几乎一样的，只是中间经过Model.php做了一些处理和封装，具体内部的调用就不多啰嗦了，总体的流程与我们上面分析的相同。</p>
<h3 id="0x04-5-0-10版本的一处注入"><a href="#0x04-5-0-10版本的一处注入" class="headerlink" title="0x04 5.0.10版本的一处注入"></a>0x04 5.0.10版本的一处注入</h3><p>写了这么多，不找个漏洞确实不太合适。根据前面3.2.4分析的，如果允许以数组的形式传入参数，在解析条件运算的时候没有任何过滤，filterExp方法是最后也可能是唯一一道防线，如果他出了问题呢？</p>
<p>首先看5.0.10与5.0.11的filterExp方法的差别：</p>
<p>5.0.10</p>
<p><img src="http://mdpicture.oss-cn-beijing.aliyuncs.com///170930/AgbIHbijlb.png" alt="mark"></p>
<p>5.0.11</p>
<p><img src="http://mdpicture.oss-cn-beijing.aliyuncs.com///170930/EEK4f6GF6m.png" alt="mark"></p>
<p>增加了一个<code>NOT LIKE</code>的匹配，再看一下5.0.10与5.0.9框架提供的数据库表达式的差别：</p>
<p>thinkphp\library\think\db\Builder.php</p>
<p>5.0.9</p>
<p><img src="http://mdpicture.oss-cn-beijing.aliyuncs.com///170930/L5eFhj2d3j.png" alt="mark"></p>
<p>5.0.10</p>
<p><img src="http://mdpicture.oss-cn-beijing.aliyuncs.com///170930/bCK353Ca8l.png" alt="mark"></p>
<p>5.0.10新增了一个<code>not like</code>的表达式，但是filterExp方法并没有做出相应的修改，导致漏洞的出现。</p>
<p><img src="http://mdpicture.oss-cn-beijing.aliyuncs.com///170930/flEjf48ggk.png" alt="mark"></p>
<p>由于是框架低层出了问题，不管用什么方法操作数据库都会存在漏洞。</p>
<p>防御的话更新到5.0.11就好了，还有在开发过程中，虽然参数绑定非常方便，最好还是使用input助手函数来获取参数。</p>
<h3 id="0x05-最后"><a href="#0x05-最后" class="headerlink" title="0x05 最后"></a>0x05 最后</h3><p>本来想十一放假前完成，磕磕绊绊断断续续一直到现在，本来只是想看一下框架底层如何保证数据库安全的，读的时候就像看一下到底是怎么运行怎么调用的。在读代码的过程遇到了许多困难，也看到了许多骚操作，之后要多学习一下php的高级用法，多读读源码。最后奶一口thinkphp，毕竟是国货，希望它越来越好吧，2333333333。</p>

        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>
        <div id="lv-container"></div>
        <div class="giscus"></div>
    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>  Theme <a target="_blank" rel="noopener" href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = ""
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>

<script src="/js/index.js"></script>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>






</html>
